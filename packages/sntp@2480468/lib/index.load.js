montageDefine("2480468","lib/index",{dependencies:["dgram","dns","hoek"],factory:function(e,t,n){var r=e("dgram"),i=e("dns"),s=e("hoek"),o={};t.time=function(e,t){arguments.length!==2&&(t=arguments[0],e={});var n=s.clone(e);n.host=n.host||"pool.ntp.org",n.port=n.port||123,n.resolveReference=n.resolveReference||!1;var u=0,a=0,f=!1,l=function(e,n){u&&(clearTimeout(u),u=0);if(!f)return f=!0,c.removeAllListeners(),c.close(),t(e,n)},c=r.createSocket("udp4");c.once("error",function(e){return l(e)}),c.on("message",function(e,t){var r=Date.now(),s=new o.NtpMessage(e);if(!s.isValid)return l(new Error("Invalid server response"),s);if(s.originateTimestamp!==a)return l(new Error("Wrong originate timestamp"),s);var u=s.originateTimestamp,f=s.receiveTimestamp,c=s.transmitTimestamp,h=r;s.d=h-u-(c-f),s.t=(f-u+(c-h))/2,s.receivedLocally=r;if(!n.resolveReference||s.stratum!=="secondary")return l(null,s);i.reverse(s.referenceId,function(e,t){return e||(s.referenceHost=t[0]),l(null,s)})}),n.timeout&&(u=setTimeout(function(){return u=0,l(new Error("Timeout"))},n.timeout));var h=new Buffer(48);for(var p=0;p<48;p++)h[p]=0;h[0]=35,a=Date.now(),o.fromMsecs(a,h,40),c.send(h,0,h.length,n.port,n.host,function(e,t){if(e||t!==48)return l(e||new Error("Could not send entire message"))})},o.NtpMessage=function(e){this.isValid=!1;if(e.length!==48)return;var t=e[0]>>6;switch(t){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}var n=(e[0]&56)>>3;this.version=n;var r=e[0]&7;switch(r){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}var i=e[1];i===0?this.stratum="death":i===1?this.stratum="primary":i<=15?this.stratum="secondary":this.stratum="reserved",this.pollInterval=Math.round(Math.pow(2,e[2]))*1e3,this.precision=Math.pow(2,e[3])*1e3;var s=256*(256*(256*e[4]+e[5])+e[6])+e[7];this.rootDelay=1e3*(s/65536),this.rootDispersion=((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16))*1e3,this.referenceId="";switch(this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=o.toMsecs(e,16),this.originateTimestamp=o.toMsecs(e,24),this.receiveTimestamp=o.toMsecs(e,32),this.transmitTimestamp=o.toMsecs(e,40),this.version===4&&this.stratum!=="reserved"&&this.mode==="server"&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this},o.toMsecs=function(e,t){var n=0,r=0;for(var i=0;i<4;++i)n=n*256+e[t+i];for(i=4;i<8;++i)r=r*256+e[t+i];return(n-2208988800+r/Math.pow(2,32))*1e3},o.fromMsecs=function(e,t,n){var r=Math.floor(e/1e3)+2208988800,i=Math.round(e%1e3/1e3*Math.pow(2,32));t[n+0]=(r&4278190080)>>24,t[n+1]=(r&16711680)>>16,t[n+2]=(r&65280)>>8,t[n+3]=r&255,t[n+4]=(i&4278190080)>>24,t[n+5]=(i&16711680)>>16,t[n+6]=(i&65280)>>8,t[n+7]=i&255},o.last={offset:0,expires:0,host:"",port:0},t.offset=function(e,n){arguments.length!==2&&(n=arguments[0],e={});var r=Date.now(),i=e.clockSyncRefresh||864e5;if(o.last.offset&&o.last.host===e.host&&o.last.port===e.port&&r<o.last.expires){process.nextTick(function(){n(null,o.last.offset)});return}t.time(e,function(t,s){return t?n(t,0):(o.last={offset:Math.round(s.t),expires:r+i,host:e.host,port:e.port},n(null,o.last.offset))})},o.now={intervalId:0},t.start=function(e,n){arguments.length!==2&&(n=arguments[0],e={});if(o.now.intervalId){process.nextTick(function(){n()});return}t.offset(e,function(r,i){return o.now.intervalId=setInterval(function(){t.offset(e,function(){})},e.clockSyncRefresh||864e5),n()})},t.stop=function(){if(!o.now.intervalId)return;clearInterval(o.now.intervalId),o.now.intervalId=0},t.isLive=function(){return!!o.now.intervalId},t.now=function(){var e=Date.now();return!t.isLive()||e>=o.last.expires?e:e+o.last.offset}}})