montageDefine("2480468","test/index",{dependencies:["dgram","lab","../lib"],factory:function(e,t,n){var r=e("dgram"),i=e("lab"),s=e("../lib"),o={},u=i.expect,a=i.before,f=i.after,l=i.experiment,c=i.test;l("SNTP",function(){l("#time",function(){c("returns consistent result over multiple tries",function(e){s.time(function(t,n){u(t).to.not.exist,u(n).to.exist;var r=n.t;s.time(function(t,n){u(t).to.not.exist,u(n).to.exist;var i=n.t;u(Math.abs(r-i)).is.below(200),e()})})}),c("resolves reference IP",function(e){s.time({host:"ntp.exnet.com",resolveReference:!0},function(t,n){u(t).to.not.exist,u(n).to.exist,u(n.referenceHost).to.exist,e()})}),c("times out on no response",function(e){s.time({port:124,timeout:100},function(t,n){u(t).to.exist,u(n).to.not.exist,u(t.message).to.equal("Timeout"),e()})}),c("errors on error event",function(e){var t=r.createSocket;r.createSocket=function(e){r.createSocket=t;var n=r.createSocket(e);return process.nextTick(function(){n.emit("error",new Error("Fake"))}),n},s.time(function(t,n){u(t).to.exist,u(n).to.not.exist,u(t.message).to.equal("Fake"),e()})}),c("times out on invalid host",function(e){s.time({host:"error",timeout:1e4},function(t,n){u(t).to.exist,u(n).to.not.exist,u(t.message).to.equal("getaddrinfo ENOTFOUND"),e()})}),c("fails on bad response buffer size",function(e){var t=r.createSocket("udp4");t.on("message",function(e,n){var e=new Buffer(10);t.send(e,0,e.length,n.port,n.address,function(e,n){t.close()})}),t.bind(49123),s.time({host:"localhost",port:49123},function(t,n){u(t).to.exist,u(t.message).to.equal("Invalid server response"),e()})});var e=function(e){var t=r.createSocket("udp4");t.on("message",function(n,r){var n=new Buffer([36,1,0,227,0,0,0,0,0,0,0,0,65,67,84,83,212,168,45,199,28,93,73,27,212,168,45,230,103,239,157,178,212,168,45,230,113,237,181,251,212,168,45,230,113,238,108,197]);for(var i=0,s=e.length;i<s;++i)n[e[i][0]]=e[i][1];t.send(n,0,n.length,r.port,r.address,function(e,n){t.close()})}),t.bind(49123)};c("fails on bad version",function(t){e([[0,28]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.version).to.equal(3),u(e.message).to.equal("Invalid server response"),t()})}),c("fails on bad originate timestamp and alarm li",function(t){e([[0,228]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(e.message).to.equal("Wrong originate timestamp"),u(n.leapIndicator).to.equal("alarm"),t()})}),c("returns time with death stratum and last61 li",function(t){e([[0,100],[1,0]]),s.time({host:"localhost",port:49123},function(e,n){u(n.stratum).to.equal("death"),u(n.leapIndicator).to.equal("last-minute-61"),t()})}),c("returns time with reserved stratum and last59 li",function(t){e([[0,164],[1,31]]),s.time({host:"localhost",port:49123},function(e,n){u(n.stratum).to.equal("reserved"),u(n.leapIndicator).to.equal("last-minute-59"),t()})}),c("fails on bad mode (symmetric-active)",function(t){e([[0,33]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.mode).to.equal("symmetric-active"),t()})}),c("fails on bad mode (symmetric-passive)",function(t){e([[0,34]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.mode).to.equal("symmetric-passive"),t()})}),c("fails on bad mode (client)",function(t){e([[0,35]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.mode).to.equal("client"),t()})}),c("fails on bad mode (broadcast)",function(t){e([[0,37]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.mode).to.equal("broadcast"),t()})}),c("fails on bad mode (reserved)",function(t){e([[0,38]]),s.time({host:"localhost",port:49123},function(e,n){u(e).to.exist,u(n.mode).to.equal("reserved"),t()})})}),l("#offset",function(){c("gets the current offset",function(e){s.offset(function(t,n){u(t).to.not.exist,u(n).to.not.equal(0),e()})}),c("gets the current offset from cache",function(e){s.offset(function(t,n){u(t).to.not.exist,u(n).to.not.equal(0);var r=n;s.offset({},function(t,n){u(t).to.not.exist,u(n).to.equal(r),e()})})}),c("fails getting the current offset on invalid server",function(e){s.offset({host:"error"},function(t,n){u(t).to.exist,u(n).to.equal(0),e()})})}),l("#now",function(){c("starts auto-sync, gets now, then stops",function(e){s.stop();var t=s.now();u(t).to.equal(Date.now()),s.start(function(){var t=s.now();u(t).to.not.equal(Date.now()),s.stop(),e()})}),c("starts twice",function(e){s.start(function(){s.start(function(){var t=s.now();u(t).to.not.equal(Date.now()),s.stop(),e()})})}),c("starts auto-sync, gets now, waits, gets again after timeout",function(e){s.stop();var t=s.now();u(t).to.equal(Date.now()),s.start({clockSyncRefresh:100},function(){var t=s.now();u(t).to.not.equal(Date.now()),u(t).to.equal(s.now()),setTimeout(function(){u(s.now()).to.not.equal(t),s.stop(),e()},110)})})})})}})