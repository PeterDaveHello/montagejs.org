function HttpSignatureError(e,t){Error.captureStackTrace&&Error.captureStackTrace(this,t||HttpSignatureError),this.message=e,this.name=t.name}function ExpiredRequestError(e){HttpSignatureError.call(this,e,ExpiredRequestError)}function InvalidHeaderError(e){HttpSignatureError.call(this,e,InvalidHeaderError)}function InvalidParamsError(e){HttpSignatureError.call(this,e,InvalidParamsError)}function MissingHeaderError(e){HttpSignatureError.call(this,e,MissingHeaderError)}var assert=require("assert-plus"),util=require("util"),Algorithms={"rsa-sha1":!0,"rsa-sha256":!0,"rsa-sha512":!0,"dsa-sha1":!0,"hmac-sha1":!0,"hmac-sha256":!0,"hmac-sha512":!0},State={New:0,Params:1,Signature:2},ParamsState={Name:0,Value:1};util.inherits(HttpSignatureError,Error),util.inherits(ExpiredRequestError,HttpSignatureError),util.inherits(InvalidHeaderError,HttpSignatureError),util.inherits(InvalidParamsError,HttpSignatureError),util.inherits(MissingHeaderError,HttpSignatureError),module.exports={parseRequest:function(t,n){assert.object(t,"request"),assert.object(t.headers,"request.headers"),n===undefined&&(n={}),n.headers===undefined&&(n.headers=[t.headers["x-date"]?"x-date":"date"]),assert.object(n,"options"),assert.arrayOfString(n.headers,"options.headers"),assert.optionalNumber(n.clockSkew,"options.clockSkew");if(!t.headers.authorization)throw new MissingHeaderError("no authorization header present in the request");n.clockSkew=n.clockSkew||300;var r=0,i=State.New,s=ParamsState.Name,o="",u="",a={scheme:"",params:{},signature:"",signingString:"",get algorithm(){return this.params.algorithm.toUpperCase()},get keyId(){return this.params.keyId}},f=t.headers.authorization;for(r=0;r<f.length;r++){var l=f.charAt(r);switch(Number(i)){case State.New:l!==" "?a.scheme+=l:i=State.Params;break;case State.Params:switch(Number(s)){case ParamsState.Name:l==='"'?(a.params[o]="",u="",s=ParamsState.Value):l===" "?i=State.Signature:l!=="="&&l!==","&&(o+=l);break;case ParamsState.Value:l==='"'?(a.params[o]=u,o="",s=ParamsState.Name):u+=l;break;default:throw new Error("Invalid substate")}break;case State.Signature:a.signature+=l;break;default:throw new Error("Invalid substate")}}!a.params.headers||a.params.headers===""?t.headers["x-date"]?a.params.headers=["x-date"]:a.params.headers=["date"]:a.params.headers=a.params.headers.split(" ");if(!a.scheme||a.scheme!=="Signature")throw new InvalidHeaderError('scheme was not "Signature"');if(!a.params.keyId)throw new InvalidHeaderError("keyId was not specified");if(!a.params.algorithm)throw new InvalidHeaderError("algorithm was not specified");if(!a.signature)throw new InvalidHeaderError("signature was empty");a.params.algorithm=a.params.algorithm.toLowerCase();if(!Algorithms[a.params.algorithm])throw new InvalidParamsError(a.params.algorithm+" is not supported");for(r=0;r<a.params.headers.length;r++){var c=a.params.headers[r].toLowerCase();a.params.headers[r]=c;var h;if(c!=="request-line"){h=t.headers[c];if(!h)throw new MissingHeaderError(c+" was not in the request")}else h=t.method+" "+t.url+" HTTP/"+t.httpVersion;a.signingString+=h,r+1<a.params.headers.length&&(a.signingString+="\n")}var p;if(t.headers.date||t.headers["x-date"]){t.headers["x-date"]?p=new Date(t.headers["x-date"]):p=new Date(t.headers.date);var d=new Date,v=Math.abs(d.getTime()-p.getTime());if(v>n.clockSkew*1e3)throw new ExpiredRequestError("clock skew of "+v/1e3+"s was greater than "+n.clockSkew+"s")}n.headers.forEach(function(e){if(a.params.headers.indexOf(e)<0)throw new MissingHeaderError(e+" was not a signed header")});if(n.algorithms&&n.algorithms.indexOf(a.params.algorithm)===-1)throw new InvalidParamsError(a.params.algorithm+" is not a supported algorithm");return a}}