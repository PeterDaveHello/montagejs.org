montageDefine("3142047","lib/signer",{dependencies:["assert-plus","crypto","http","util"],factory:function(e,t,n){function f(e){this.name="MissingHeaderError",this.message=e,this.stack=(new Error).stack}function l(e){this.name="InvalidAlgorithmError",this.message=e,this.stack=(new Error).stack}function c(e){return parseInt(e,10)<10&&(e="0"+e),e}function h(){var e=new Date,t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return n[e.getUTCDay()]+", "+c(e.getUTCDate())+" "+t[e.getUTCMonth()]+" "+e.getUTCFullYear()+" "+c(e.getUTCHours())+":"+c(e.getUTCMinutes())+":"+c(e.getUTCSeconds())+" GMT"}var r=e("assert-plus"),i=e("crypto"),s=e("http"),o=e("util").format,u={"rsa-sha1":!0,"rsa-sha256":!0,"rsa-sha512":!0,"dsa-sha1":!0,"hmac-sha1":!0,"hmac-sha256":!0,"hmac-sha512":!0},a='Signature keyId="%s",algorithm="%s",headers="%s" %s';f.prototype=new Error,l.prototype=new Error,n.exports={signRequest:function(t,n){r.object(t,"request"),r.object(n,"options"),r.optionalString(n.algorithm,"options.algorithm"),r.string(n.keyId,"options.keyId"),r.optionalArrayOfString(n.headers,"options.headers"),t.getHeader("Date")||t.setHeader("Date",h()),n.headers||(n.headers=["date"]),n.algorithm||(n.algorithm="rsa-sha256"),n.algorithm=n.algorithm.toLowerCase();if(!u[n.algorithm])throw new l(n.algorithm+" is not supported");var s,c="";for(s=0;s<n.headers.length;s++){if(typeof n.headers[s]!="string")throw new TypeError("options.headers must be an array of Strings");var p=n.headers[s].toLowerCase();t.getHeader(p);var d=t.getHeader(p);if(!d){if(p!=="request-line")throw new f(p+" was not in the request");d=t.method+" "+t.path+" HTTP/1.1"}c+=d,s+1<n.headers.length&&(c+="\n")}var v=n.algorithm.match(/(hmac|rsa)-(\w+)/),m;if(v[1]==="hmac"){var g=i.createHmac(v[2].toUpperCase(),n.key);g.update(c),m=g.digest("base64")}else{var y=i.createSign(n.algorithm.toUpperCase());y.update(c),m=y.sign(n.key,"base64")}return t.setHeader("Authorization",o(a,n.keyId,n.algorithm,n.headers.join(" "),m)),!0}}}})