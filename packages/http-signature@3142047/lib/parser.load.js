montageDefine("3142047","lib/parser",{dependencies:["assert-plus","util"],factory:function(e,t,n){function a(e,t){Error.captureStackTrace&&Error.captureStackTrace(this,t||a),this.message=e,this.name=t.name}function f(e){a.call(this,e,f)}function l(e){a.call(this,e,l)}function c(e){a.call(this,e,c)}function h(e){a.call(this,e,h)}var r=e("assert-plus"),i=e("util"),s={"rsa-sha1":!0,"rsa-sha256":!0,"rsa-sha512":!0,"dsa-sha1":!0,"hmac-sha1":!0,"hmac-sha256":!0,"hmac-sha512":!0},o={New:0,Params:1,Signature:2},u={Name:0,Value:1};i.inherits(a,Error),i.inherits(f,a),i.inherits(l,a),i.inherits(c,a),i.inherits(h,a),n.exports={parseRequest:function(t,n){r.object(t,"request"),r.object(t.headers,"request.headers"),n===undefined&&(n={}),n.headers===undefined&&(n.headers=[t.headers["x-date"]?"x-date":"date"]),r.object(n,"options"),r.arrayOfString(n.headers,"options.headers"),r.optionalNumber(n.clockSkew,"options.clockSkew");if(!t.headers.authorization)throw new h("no authorization header present in the request");n.clockSkew=n.clockSkew||300;var i=0,a=o.New,p=u.Name,d="",v="",m={scheme:"",params:{},signature:"",signingString:"",get algorithm(){return this.params.algorithm.toUpperCase()},get keyId(){return this.params.keyId}},g=t.headers.authorization;for(i=0;i<g.length;i++){var y=g.charAt(i);switch(Number(a)){case o.New:y!==" "?m.scheme+=y:a=o.Params;break;case o.Params:switch(Number(p)){case u.Name:y==='"'?(m.params[d]="",v="",p=u.Value):y===" "?a=o.Signature:y!=="="&&y!==","&&(d+=y);break;case u.Value:y==='"'?(m.params[d]=v,d="",p=u.Name):v+=y;break;default:throw new Error("Invalid substate")}break;case o.Signature:m.signature+=y;break;default:throw new Error("Invalid substate")}}!m.params.headers||m.params.headers===""?t.headers["x-date"]?m.params.headers=["x-date"]:m.params.headers=["date"]:m.params.headers=m.params.headers.split(" ");if(!m.scheme||m.scheme!=="Signature")throw new l('scheme was not "Signature"');if(!m.params.keyId)throw new l("keyId was not specified");if(!m.params.algorithm)throw new l("algorithm was not specified");if(!m.signature)throw new l("signature was empty");m.params.algorithm=m.params.algorithm.toLowerCase();if(!s[m.params.algorithm])throw new c(m.params.algorithm+" is not supported");for(i=0;i<m.params.headers.length;i++){var b=m.params.headers[i].toLowerCase();m.params.headers[i]=b;var w;if(b!=="request-line"){w=t.headers[b];if(!w)throw new h(b+" was not in the request")}else w=t.method+" "+t.url+" HTTP/"+t.httpVersion;m.signingString+=w,i+1<m.params.headers.length&&(m.signingString+="\n")}var E;if(t.headers.date||t.headers["x-date"]){t.headers["x-date"]?E=new Date(t.headers["x-date"]):E=new Date(t.headers.date);var S=new Date,x=Math.abs(S.getTime()-E.getTime());if(x>n.clockSkew*1e3)throw new f("clock skew of "+x/1e3+"s was greater than "+n.clockSkew+"s")}n.headers.forEach(function(e){if(m.params.headers.indexOf(e)<0)throw new h(e+" was not a signed header")});if(n.algorithms&&n.algorithms.indexOf(m.params.algorithm)===-1)throw new c(m.params.algorithm+" is not a supported algorithm");return m}}}})