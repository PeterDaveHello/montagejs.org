montageDefine("6b26a70","tests/test-redirect",{dependencies:["./server","assert","../index","cookie-jar"],factory:function(e,t,n){var r=e("./server"),i=e("assert"),s=e("../index"),o=e("cookie-jar"),u=o.Jar,a=r.createServer();a.listen(a.port,function(){function r(n,r){var s=r+"_landing";a.on("/"+r,function(i,o){t[r]=!0,o.writeHead(n,{location:e+"/"+s,"set-cookie":"ham=eggs"}),o.end()}),a.on("/"+s,function(e,n){if(e.method!=="GET"){console.error("Got a non-GET request to the redirect destination URL"),n.writeHead(400),n.end();return}i.equal(e.headers.cookie,"foo=bar; quux=baz; ham=eggs"),t[s]=!0,n.writeHead(200),n.end(s)})}function c(){l+=1,l==9&&(console.log(n+" tests passed."),a.close())}var e="http://localhost:"+a.port,t={},n=0;r(301,"temp"),r(302,"perm"),r(302,"nope");var f=new u;f.add(new o("quux=baz")),s({uri:e+"/perm",jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);i.ok(t.perm,"Original request is to /perm"),i.ok(t.perm_landing,"Forward to permanent landing URL"),i.equal(s,"perm_landing","Got permanent landing content"),n+=1,c()}),s({uri:e+"/temp",jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(t.temp_landing,"Forward to temporary landing URL"),i.equal(s,"temp_landing","Got temporary landing content"),n+=1,c()}),s({uri:e+"/nope",jar:f,headers:{cookie:"foo=bar"},followRedirect:!1},function(e,r,s){if(e)throw e;if(r.statusCode!==302)throw new Error("Status is not 302: "+r.statusCode);i.ok(t.nope,"Original request to /nope"),i.ok(!t.nope_landing,"No chasing the redirect"),i.equal(r.statusCode,302,"Response is the bounce itself"),n+=1,c()}),s.post(e+"/temp",{jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(!t.temp_landing,"No chasing the redirect when post"),i.equal(r.statusCode,301,"Response is the bounce itself"),n+=1,c()}),s.post({uri:e+"/temp",followAllRedirects:!0,jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(t.temp_landing,"Forward to temporary landing URL"),i.equal(s,"temp_landing","Got temporary landing content"),n+=1,c()}),s.post({uri:e+"/temp",followAllRedirects:!1,jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(!t.temp_landing,"No chasing the redirect"),i.equal(r.statusCode,301,"Response is the bounce itself"),n+=1,c()}),s.del(e+"/temp",{jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode<301)throw new Error("Status is not a redirect.");i.ok(t.temp,"Original request is to /temp"),i.ok(!t.temp_landing,"No chasing the redirect when delete"),i.equal(r.statusCode,301,"Response is the bounce itself"),n+=1,c()}),s.del(e+"/temp",{followRedirect:!0,jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==301)throw new Error("Status is not 301: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(!t.temp_landing,"No chasing the redirect when delete"),i.equal(r.statusCode,301,"Response is the bounce itself"),n+=1,c()}),s.del(e+"/temp",{followAllRedirects:!0,jar:f,headers:{cookie:"foo=bar"}},function(e,r,s){if(e)throw e;if(r.statusCode!==200)throw new Error("Status is not 200: "+r.statusCode);i.ok(t.temp,"Original request is to /temp"),i.ok(t.temp_landing,"Forward to temporary landing URL"),i.equal(s,"temp_landing","Got temporary landing content"),n+=1,c()});var l=0})}})