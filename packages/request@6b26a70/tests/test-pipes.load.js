montageDefine("6b26a70","tests/test-pipes",{dependencies:["./server","events","stream","assert","fs","../index","path","util"],factory:function(e,t,n){function h(e){this.str=e,this.buf="",this.on("data",function(e){this.buf+=e}),this.on("end",function(){o.equal(this.str,this.buf)}),this.writable=!0}var r=e("./server"),i=e("events"),s=e("stream"),o=e("assert"),u=e("fs"),a=e("../index"),f=e("path"),l=e("util"),c=r.createServer(3453);l.inherits(h,s.Stream),h.prototype.write=function(e){this.emit("data",e)},h.prototype.end=function(e){e&&emit("data",e),this.emit("end")},c.listen(c.port,function(){counter=0;var e=function(){counter-=1,counter===0&&(console.log("All tests passed."),setTimeout(function(){process.exit()},500))};c.once("/push",r.createPostValidator("mydata"));var t=new s.Stream;t.readable=!0,counter++;var n=a.put({url:"http://localhost:3453/push"},function(){e()});t.pipe(n),t.emit("data","mydata"),t.emit("end"),c.once("/push-json",r.createPostValidator('{"foo":"bar"}',"application/json"));var i=new s.Stream;i.readable=!0,counter++;var l=a.put({url:"http://localhost:3453/push-json",json:!0},function(){e()});i.pipe(l),i.emit("data",JSON.stringify({foo:"bar"})),i.emit("end"),c.once("/pull",r.createGetResponse("mypulldata"));var p=new s.Stream;p.writable=!0,counter++,a({url:"http://localhost:3453/pull"}).pipe(p);var d="";p.write=function(e){d+=e},p.end=function(){o.equal(d,"mypulldata"),e()},c.on("/cat",function(t,n){if(t.method==="GET")n.writeHead(200,{"content-type":"text/plain-test","content-length":4}),n.end("asdf");else if(t.method==="PUT"){o.equal(t.headers["content-type"],"text/plain-test"),o.equal(t.headers["content-length"],4);var r="";t.on("data",function(e){r+=e}),t.on("end",function(){n.writeHead(201),n.end(),o.equal(r,"asdf"),e()})}}),c.on("/pushjs",function(t,n){t.method==="PUT"&&(o.equal(t.headers["content-type"],"application/javascript"),e())}),c.on("/catresp",function(e,t){a.get("http://localhost:3453/cat").pipe(t)}),c.on("/doodle",function(e,t){e.headers["x-oneline-proxy"]&&t.setHeader("x-oneline-proxy","yup"),t.writeHead("200",{"content-type":"image/jpeg"}),u.createReadStream(f.join(__dirname,"googledoodle.jpg")).pipe(t)}),c.on("/onelineproxy",function(e,t){var n=a("http://localhost:3453/doodle");e.pipe(n),n.pipe(t)}),counter++,u.createReadStream(__filename).pipe(a.put("http://localhost:3453/pushjs")),counter++,a.get("http://localhost:3453/cat").pipe(a.put("http://localhost:3453/cat")),counter++,a.get("http://localhost:3453/catresp",function(t,n,r){o.equal(n.headers["content-type"],"text/plain-test"),o.equal(n.headers["content-length"],4),e()});var v=u.createWriteStream(f.join(__dirname,"test.jpg"));counter++,a.get("http://localhost:3453/doodle").pipe(v),v.on("close",function(){o.deepEqual(u.readFileSync(f.join(__dirname,"googledoodle.jpg")),u.readFileSync(f.join(__dirname,"test.jpg"))),e()}),process.on("exit",function(){u.unlinkSync(f.join(__dirname,"test.jpg"))}),counter++,a.get({uri:"http://localhost:3453/onelineproxy",headers:{"x-oneline-proxy":"nope"}},function(t,n,r){o.equal(n.headers["x-oneline-proxy"],"yup"),e()}),c.on("/afterresponse",function(e,t){t.write("d"),t.end()}),counter++;var m=a.post("http://localhost:3453/afterresponse").on("response",function(){var t=new h("d");m.pipe(t),t.on("end",e)});c.on("/forward1",function(e,t){t.writeHead(302,{location:"/forward2"}),t.end()}),c.on("/forward2",function(e,t){t.writeHead("200",{"content-type":"image/png"}),t.write("d"),t.end()}),counter++;var g=new h("d");g.on("end",e),a.get("http://localhost:3453/forward1").pipe(g),c.once("/opts",r.createGetResponse("opts response"));var y=new s.Stream;y.writable=!0;var b="";y.write=function(t){b+=t,b==="opts response"&&setTimeout(e,10)},y.end=function(){o.fail("end called")},counter++,a({url:"http://localhost:3453/opts"}).pipe(y,{end:!1})})}})