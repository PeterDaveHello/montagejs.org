var Montage=require("montage").Montage,UUID=require("core/uuid"),MutableEvent=require("core/event/mutable-event").MutableEvent,Serializer=require("core/serialization").Serializer,Deserializer=require("core/serialization").Deserializer,defaultEventManager;if("undefined"!=typeof window){window.Touch===void 0&&"ontouchstart"in window&&(window.Touch=function(){},function(){var n;document.addEventListener("touchstart",n=function(e){window.Touch=e.touches[0].constructor,document.nativeRemoveEventListener?document.nativeRemoveEventListener("touchstart",n,!0):document.removeEventListener("touchstart",n,!0),defaultEventManager&&defaultEventManager.isStoringPointerEvents&&(defaultEventManager.isStoringPointerEvents=!1,defaultEventManager.isStoringPointerEvents=!0)},!0)}());var EventListenerDescriptor=Montage.specialize({type:{value:null},listener:{value:null},capture:{value:null}});Serializer.defineSerializationUnit("listeners",function(n,e){var s,a,t,o=defaultEventManager,p=e.uuid,l=[];for(var i in o.registeredEventListeners)if(s=o.registeredEventListeners[i],a=s&&s[p])for(var r in a.listeners)t=a.listeners[r],l.push({type:i,listener:n.addObjectReference(t.listener),capture:t.capture});return l.length>0?l:void 0}),Deserializer.defineDeserializationUnit("listeners",function(n,e,s){for(var a,t=0;a=s[t];t++)e.addEventListener(a.type,a.listener,a.capture)});var NONE=Event.NONE,CAPTURING_PHASE=Event.CAPTURING_PHASE,AT_TARGET=Event.AT_TARGET,BUBBLING_PHASE=Event.BUBBLING_PHASE,FUNCTION_TYPE="function",EventManager=exports.EventManager=Montage.specialize({eventDefinitions:{value:{abort:{bubbles:!1,cancelable:!1},beforeunload:{bubbles:!1},blur:{bubbles:!1,cancelable:!1},change:{bubbles:!0,cancelable:!1},click:{bubbles:!0,cancelable:!0},close:{bubbles:!1,cancelable:!1},compositionend:{bubbles:!0,cancelable:!1},compositionstart:{bubbles:!0,cancelable:!0},compositionupdate:{bubbles:!0,cancelable:!1},contextmenu:{bubbles:!0,cancelable:!0},copy:{bubbles:!0,cancelable:!0},cut:{bubbles:!0,cancelable:!0},dblclick:{bubbles:!0,cancelable:!1},DOMActivate:{bubbles:!0,cancelable:!0,deprecated:!0},DOMMouseScroll:{bubbles:!0},drag:{bubbles:!0,cancelable:!0},dragend:{bubbles:!0,cancelable:!1},dragenter:{bubbles:!0,cancelable:!0},dragleave:{bubbles:!0,cancelable:!1},dragover:{bubbles:!0,cancelable:!0},dragstart:{bubbles:!0,cancelable:!0},drop:{bubbles:!0,cancelable:!0},error:{bubbles:function(n){return!(XMLHttpRequest.prototype.isPrototypeOf(n)||n.tagName&&"VIDEO"===n.tagName.toUpperCase()||n.tagName&&"AUDIO"===n.tagName.toUpperCase())},cancelable:!1},focus:{bubbles:!1,cancelable:!1},focusin:{bubbles:!0,cancelable:!1},focusout:{bubbles:!0,cancelable:!1},input:{bubbles:!0,cancelable:!1},keydown:{bubbles:!0,cancelable:!1},keypress:{bubbles:!0,cancelable:!1},keyup:{bubbles:!0,cancelable:!1},load:{bubbles:!1,cancelable:!1},loadend:{bubbles:!1,cancelable:!1},loadstart:{bubbles:!1,cancelable:!1},message:{bubbles:!1,cancelable:!1},mousedown:{bubbles:!0,cancelable:!0},mouseenter:{bubbles:!1,cancelable:!1},mouseleave:{bubbles:!1,cancelable:!1},mousemove:{bubbles:!0,cancelable:!0},mouseout:{bubbles:!0,cancelable:!0},mouseover:{bubbles:!0,cancelable:!0},mouseup:{bubbles:!0,cancelable:!0},mousewheel:{bubbles:!0},orientationchange:{bubbles:!1},paste:{bubbles:!0,cancelable:!0},progress:{bubbles:!1,cancelable:!1},reset:{bubbles:!0,cancelable:!1},resize:{bubbles:!1,cancelable:!1},scroll:{bubbles:function(n){return!!n.defaultView},cancelable:!1},select:{bubbles:!0,cancelable:!1},submit:{bubbles:!0,cancelable:!0},touchcancel:{bubbles:!0,cancelable:!1},touchend:{bubbles:!0,cancelable:!0},touchmove:{bubbles:!0,cancelable:!0},touchstart:{bubbles:!0,cancelable:!0},unload:{bubbles:!1,cancelable:!1},wheel:{bubbles:!0,cancelable:!0}}},_DOMPasteboardElement:{value:null,enumerable:!1},_delegate:{value:null,enumerable:!1},delegate:{enumerable:!1,get:function(){return this._delegate},set:function(n){this._delegate=n}},_application:{value:null,enumerable:!1},application:{enumerable:!1,get:function(){return this._application},set:function(n){this._application=n}},_registeredWindows:{value:null,enumerable:!1},_windowsAwaitingFinalRegistration:{value:{},enumerable:!1},initWithWindow:{enumerable:!1,value:function(n){if(this._registeredWindows)throw"EventManager has already been initialized";return this.registerWindow(n),this}},registerWindow:{enumerable:!1,value:function(n){if(n.defaultEventManager&&n.defaultEventManager!==this)throw"EventManager cannot register a window already registered to another EventManager";if(this._registeredWindows&&this._registeredWindows.indexOf(n)>=0)throw"EventManager cannot register a window more than once";if(this._registeredWindows||(this._registeredWindows=[]),n.uuid&&0!==n.uuid.length||(n.uuid=UUID.generate()),this._windowsAwaitingFinalRegistration[n.uuid]!==n){if(n.Element.prototype.nativeAddEventListener=n.Element.prototype.addEventListener,Object.defineProperty(n,"nativeAddEventListener",{configurable:!0,value:n.addEventListener}),Object.getPrototypeOf(n.document).nativeAddEventListener=n.document.addEventListener,n.XMLHttpRequest.prototype.nativeAddEventListener=n.XMLHttpRequest.prototype.addEventListener,n.Worker&&(n.Worker.prototype.nativeAddEventListener=n.Worker.prototype.addEventListener),n.Element.prototype.nativeRemoveEventListener=n.Element.prototype.removeEventListener,Object.defineProperty(n,"nativeRemoveEventListener",{configurable:!0,value:n.removeEventListener}),Object.getPrototypeOf(n.document).nativeRemoveEventListener=n.document.removeEventListener,n.XMLHttpRequest.prototype.nativeRemoveEventListener=n.XMLHttpRequest.prototype.removeEventListener,n.Worker&&(n.Worker.prototype.nativeRemoveEventListener=n.Worker.prototype.removeEventListener),Object.defineProperty(n,"addEventListener",{configurable:!0,value:n.XMLHttpRequest.prototype.addEventListener=n.Element.prototype.addEventListener=Object.getPrototypeOf(n.document).addEventListener=function(e,s,a){return n.defaultEventManager.registerEventListener(this,e,s,!!a)}}),n.Worker&&(n.Worker.prototype.addEventListener=n.addEventListener),Object.defineProperty(n,"removeEventListener",{configurable:!0,value:n.XMLHttpRequest.prototype.removeEventListener=n.Element.prototype.removeEventListener=Object.getPrototypeOf(n.document).removeEventListener=function(e,s,a){return n.defaultEventManager.unregisterEventListener(this,e,s,!!a)}}),n.Worker&&(n.Worker.prototype.removeEventListener=n.removeEventListener),n.HTMLDivElement.prototype.addEventListener!==n.Element.prototype.nativeAddEventListener&&n.HTMLElement&&"addEventListener"in n.HTMLElement.prototype&&n.Components&&n.Components.interfaces){var e,s;for(e in Components.interfaces)e.match(/^nsIDOMHTML\w*Element$/)&&(e=e.replace(/^nsIDOM/,""),(e=window[e])&&(s=e.prototype,s.nativeAddEventListener=s.addEventListener,s.addEventListener=n.Element.prototype.addEventListener,s.nativeRemoveEventListener=s.removeEventListener,s.removeEventListener=n.Element.prototype.removeEventListener))}Montage.defineProperty(n.Element.prototype,"eventHandlerUUID",{value:void 0,enumerable:!1}),Montage.defineProperty(n.Element.prototype,"component",{get:function(){return defaultEventManager._elementEventHandlerByUUID[this.eventHandlerUUID]},enumerable:!1}),defaultEventManager=n.defaultEventManager=exports.defaultEventManager=this,this._registeredWindows.push(n),this._windowsAwaitingFinalRegistration[n.uuid]=n,/loaded|complete|interactive/.test(n.document.readyState)?this._finalizeWindowRegistration(n):n.document.addEventListener("DOMContentLoaded",this,!0)}}},_finalizeWindowRegistration:{enumerable:!1,value:function(n){if(this._windowsAwaitingFinalRegistration[n.uuid]!==n)throw"EventManager wasn't expecting to register this window";delete this._windowsAwaitingFinalRegistration[n.uuid],this._listenToWindow(n)}},unregisterWindow:{enumerable:!1,value:function(n){if(0>this._registeredWindows.indexOf(n))throw"EventManager cannot unregister an unregistered window";if(this._registeredWindows=this._registeredWindows.filter(function(e){return n!==e}),delete n.defaultEventManager,n.Element.prototype.addEventListener=n.Element.prototype.nativeAddEventListener,Object.defineProperty(n,"addEventListener",{configurable:!0,value:n.nativeAddEventListener}),Object.getPrototypeOf(n.document).addEventListener=n.document.nativeAddEventListener,n.XMLHttpRequest.prototype.addEventListener=n.XMLHttpRequest.prototype.nativeAddEventListener,n.Worker&&(n.Worker.prototype.addEventListener=n.Worker.prototype.nativeAddEventListener),n.Element.prototype.removeEventListener=n.Element.prototype.nativeRemoveEventListener,Object.defineProperty(n,"removeEventListener",{configurable:!0,value:n.nativeRemoveEventListener}),Object.getPrototypeOf(n.document).removeEventListener=n.document.nativeRemoveEventListener,n.XMLHttpRequest.prototype.removeEventListener=n.XMLHttpRequest.prototype.nativeRemoveEventListener,n.Worker&&(n.Worker.prototype.removeEventListener=n.Worker.prototype.nativeRemoveEventListener),n.HTMLDivElement.prototype.nativeAddEventListener!==n.Element.prototype.addEventListener&&n.HTMLElement&&"addEventListener"in n.HTMLElement.prototype&&n.Components&&n.Components.interfaces){var e,s;for(e in Components.interfaces)e.match(/^nsIDOMHTML\w*Element$/)&&(e=e.replace(/^nsIDOM/,""),(e=window[e])&&(s=e.prototype,s.addEventListener=s.nativeAddEventListener,delete s.nativeAddEventListener,s.removeEventListener=s.nativeRemoveEventListener,delete s.nativeRemoveEventListener))}delete n.Element.prototype.nativeAddEventListener,delete n.nativeAddEventListener,delete Object.getPrototypeOf(n.document).nativeAddEventListener,delete n.XMLHttpRequest.prototype.nativeAddEventListener,n.Worker&&delete n.Worker.prototype.nativeAddEventListener,delete n.Element.prototype.nativeRemoveEventListener,delete n.nativeRemoveEventListener,delete Object.getPrototypeOf(n.document).nativeRemoveEventListener,delete n.XMLHttpRequest.prototype.nativeRemoveEventListener,n.Worker&&delete n.Worker.prototype.nativeRemoveEventListener,delete n.Element.prototype.eventHandlerUUID,delete n.Element.prototype.component,this._stopListeningToWindow(n)}},unregisterWindows:{enumerable:!1,value:function(){this._registeredWindows.forEach(this.unregisterWindow)}},registeredEventListeners:{enumerable:!1,value:{}},registeredEventListenersForEventType_:{value:function(n){var e,s,a,t,o=this.registeredEventListeners[n];if(!o)return null;t={};for(e in o){s=o[e].listeners;for(a in s)t[a]=s[a]}return t}},registeredEventListenersForEventType_onTarget_:{enumerable:!1,value:function(n,e,s){var a,t;return a=e===s?s.eventManager.registeredEventListeners[n]:this.registeredEventListeners[n],a?(t=a[e.uuid],t?t.listeners:null):null}},registeredEventListenersOnTarget_:{value:function(n){var e,s,a=[];for(e in this.registeredEventListeners)s=this.registeredEventListeners[e],n.uuid in s&&a.push(s);return a}},registerEventListener:{enumerable:!1,value:function(n,e,s,a){var t,o,p,l=this.registeredEventListeners[e],i=!1,r=!1;if(n.uuid===void 0)throw Error("EventManager cannot observe a target without a uuid: "+(n.outerHTML||n));return l?((t=l[n.uuid])||(t=l[n.uuid]={target:n,listeners:{}},i=!0),o=t.listeners[s.uuid],p=a?"capture":"bubble",o?(o[p]=!0,r=!0):(o={listener:s,capture:a,bubble:!a},t.listeners[s.uuid]=o,r=!0)):(l=this.registeredEventListeners[e]={},l[n.uuid]={target:n,listeners:{}},l[n.uuid].listeners[s.uuid]={listener:s,capture:a,bubble:!a},i=!0,r=!0),i&&"function"==typeof n.nativeAddEventListener&&this._observeTarget_forEventType_(n,e),r}},unregisterEventListener:{enumerable:!1,value:function(n,e,s,a){var t,o,p,l,i,r=this.registeredEventListeners[e];if(r&&(t=r[n.uuid])){if(o=t.listeners[s.uuid],!o){for(l in t.listeners)if(i=t.listeners[l].listener,i.originalListener&&i.originalListener.uuid===s.uuid){o=t.listeners[l],s=i;break}if(!o)return}p=a?"capture":"bubble",o[p]=!1,o.bubble||o.capture||(delete t.listeners[s.uuid],0===Object.keys(t.listeners).length&&(delete r[n.uuid],0===Object.keys(r).length&&(delete this.registeredEventListeners[e],this._stopObservingTarget_forEventType_(n,e))))}}},actualDOMTargetForEventTypeOnTarget:{value:function(n,e){if(e.nativeAddEventListener){if(e.defaultView)return e;var s,a=this.eventDefinitions[n];return a?(s=typeof a.bubbles===FUNCTION_TYPE?a.bubbles(e):a.bubbles,s?e.screen?e.document:e.ownerDocument:e):e}return null}},_observedTarget_byEventType_:{value:{}},_observeTarget_forEventType_:{enumerable:!1,value:function(n,e){var s;!(s=this.actualDOMTargetForEventTypeOnTarget(e,n))||this._observedTarget_byEventType_[e]&&this._observedTarget_byEventType_[e][s.uuid]||(this._observedTarget_byEventType_[e]||(this._observedTarget_byEventType_[e]={}),this._observedTarget_byEventType_[e][s.uuid]=this,s.nativeAddEventListener(e,this,!0))}},_stopObservingTarget_forEventType_:{enumerable:!1,value:function(n,e){var s;s=this.actualDOMTargetForEventTypeOnTarget(e,n),s&&(delete this._observedTarget_byEventType_[e][s.uuid],s.nativeRemoveEventListener(e,this,!0))}},_activationHandler:{enumerable:!0,value:null},_listenToWindow:{enumerable:!1,value:function(n){if(!this._activationHandler){var e=this;this._activationHandler=function(n){var s,a=n.type;if("focus"===a||"mousedown"===a||"touchstart"===a)if(n.changedTouches){s=n.changedTouches.length;for(var t=0;s>t;t++)e._prepareComponentsForActivation(n.changedTouches[t].target)}else e._prepareComponentsForActivation(n.target)}}if(n.Touch?n.document.nativeAddEventListener("touchstart",this._activationHandler,!0):n.document.nativeAddEventListener("mousedown",this._activationHandler,!0),n.document.nativeAddEventListener("focus",this._activationHandler,!0),this.application){var s,a=this.registeredEventListenersOnTarget_(this.application);for(s in a)this._observeTarget_forEventType_(n,s)}}},_stopListeningToWindow:{enumerable:!1,value:function(n){var e,s=this.registeredEventListenersOnTarget_(this.application),a=this.registeredEventListenersOnTarget_(n);for(e in s)this._stopObservingTarget_forEventType_(n,e);for(e in a)this._stopObservingTarget_forEventType_(n,e)}},reset:{enumerable:!1,value:function(){var n,e,s,a;for(n in this.registeredEventListeners){e=this.registeredEventListeners[n];for(s in e.targets)a=e.targets[s],this._stopObservingTarget_forEventType_(a.target,n)}this.registeredEventListeners={},this._claimedPointers={}}},unload:{enumerable:!1,value:function(){this._stopListening()}},methodNameForBubblePhaseOfEventType:{enumerable:!1,value:function(n){return function(e,s){var a=s?e+"+"+s:e;return n[a]||(n[a]="handle"+(s?s.toCapitalized():"")+e.toCapitalized())}}({})},_methodNameForCapturePhaseByEventType_:{value:{}},methodNameForCapturePhaseOfEventType:{enumerable:!1,value:function(n){return function(e,s){var a=s?e+"+"+s:e;return n[a]||(n[a]="capture"+(s?s.toCapitalized():"")+e.toCapitalized())}}({})},_claimedPointers:{enumerable:!1,distinct:!0,value:{}},componentClaimingPointer:{value:function(n){return this._claimedPointers[n]}},isPointerClaimedByComponent:{value:function(n,e){if(!e)throw"Must specify a valid component to see if it claims the specified pointer, '"+e+"' is not valid.";return this._claimedPointers[n]===e}},claimPointer:{value:function(n,e){if(!n&&0!==n)throw"Must specify a valid pointer to claim, '"+n+"' is not valid.";if(!e)throw"Must specify a valid component to claim a pointer, '"+e+"' is not valid.";var s=this._claimedPointers[n];return s===e?!0:s?s.surrenderPointer(n,e)?(this._claimedPointers[n]=e,!0):!1:(this._claimedPointers[n]=e,!0)}},forfeitPointer:{value:function(n,e){if(e!==this._claimedPointers[n])throw"Not allowed to forfeit pointer '"+n+"' claimed by another component";delete this._claimedPointers[n]}},forfeitAllPointers:{value:function(n){var e,s;for(e in this._claimedPointers)s=this._claimedPointers[e],n===s&&delete this._claimedPointers[e]}},_isStoringPointerEvents:{enumerable:!1,value:!1},isStoringPointerEvents:{enumerable:!0,get:function(){return this._isStoringPointerEvents},set:function(n){n===!0?this._isStoringPointerEvents||(this._isStoringPointerEvents=!0,window.Touch&&Object.defineProperty(Touch.prototype,"velocity",{get:function(){return defaultEventManager.pointerMotion(this.identifier).velocity},set:function(){}})):(this._isStoringPointerEvents=!1,this._pointerStorage.memory={},this._isMouseDragging=!1)}},_isStoringMouseEventsWhileDraggingOnly:{enumerable:!1,value:!0},isStoringMouseEventsWhileDraggingOnly:{enumerable:!0,get:function(){return this._isStoringMouseEventsWhileDraggingOnly},set:function(n){this._isStoringMouseEventsWhileDraggingOnly=n===!0?!0:!1}},_isMouseDragging:{enumerable:!1,value:!1},_pointerStorage:{enumerable:!1,value:{memory:{},add:function(n,e){this.memory[n]||(this.memory[n]={data:Array(32),size:0,pos:0}),this.memory[n].data[this.memory[n].pos]=e,this.memory[n].size<this.memory[n].data.length&&this.memory[n].size++,this.memory[n].pos=(this.memory[n].pos+1)%this.memory[n].data.length},remove:function(n){delete this.memory[n]},clear:function(n){this.memory[n]&&(this.memory[n].size=0)},getMemory:function(n){return this.memory[n]},isStored:function(n){return this.memory[n]&&this.memory[n].size>0},storeEvent:function(n){var e;switch(n.type){case"mousedown":defaultEventManager._isMouseDragging=!0;case"mousemove":defaultEventManager._isStoringMouseEventsWhileDraggingOnly?defaultEventManager._isMouseDragging&&(this.add("mouse",{clientX:n.clientX,clientY:n.clientY,timeStamp:n.timeStamp}),Object.defineProperty(n,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}})):(this.add("mouse",{clientX:n.clientX,clientY:n.clientY,timeStamp:n.timeStamp}),Object.defineProperty(n,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}}));break;case"mouseup":this.add("mouse",{clientX:n.clientX,clientY:n.clientY,timeStamp:n.timeStamp}),Object.defineProperty(n,"velocity",{get:function(){return defaultEventManager.pointerMotion("mouse").velocity},set:function(){}});break;case"touchstart":case"touchmove":for(e=0;n.touches.length>e;e++)this.add(n.touches[e].identifier,{clientX:n.touches[e].clientX,clientY:n.touches[e].clientY,timeStamp:n.timeStamp});break;case"touchend":for(e=0;n.changedTouches.length>e;e++)this.add(n.changedTouches[e].identifier,{clientX:n.changedTouches[e].clientX,clientY:n.changedTouches[e].clientY,timeStamp:n.timeStamp})}},removeEvent:function(n){var e;switch(n.type){case"mouseup":defaultEventManager._isMouseDragging=!1,defaultEventManager._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse");break;case"touchend":for(e=0;n.changedTouches.length>e;e++)this.remove(n.changedTouches[e].identifier)}}}},_getPointerVelocityData:{enumerable:!1,value:function(n){var e,s,a,t,o,p,l,i,r,c=0,h=!0,d={x:[],y:[],time:[]};for(e=defaultEventManager._pointerStorage.getMemory(n),s=e.data.length,a=e.data[(e.pos-1+s)%s],t=o=p=a.timeStamp,l=a.clientX,i=a.clientY;h&&o>t-350&&e.size>c;)a=e.data[(e.pos-c-1+s)%s],o=a.timeStamp,r=l*l+i*i,r>2&&50>=p-o?(d.x.push(a.clientX),d.y.push(a.clientY),d.time.push(o),p=o,l=a.clientX,i=a.clientY,c++):h=!1;return d}},_fitPointerCurve:{enumerable:!1,value:function(n,e){var s,a,t,o,p,l,i,r,c,h,d,m,u,g,f,v,y,w,b,x,_,T,j,k,E,M,B,C,P,I,S,N,A,D,q,z,O,L,F=1e-4,H=e.length;do{for(d=0,m=0,u=0,g=0,f=0,v=0,w=0,b=0,x=0,_=0,T=0,j=0,E=0,M=0,B=0,C=0,P=0,I=0,N=0,A=0,D=0,q=0,z=0,O=0,h=0;H>h;h++)p=e[h],l=p.t,r=l*l,c=r*l,i=p.v,y=F*(6*(r-l)-c+2),k=6*F*(c-2*r+l),S=6*F*(r-c),L=2*F*c,v+=y*y,j+=k*k,I+=S*S,O+=L*L,d+=i*y,w+=i*k,E+=i*S,N+=i*L,u-=y,x-=k,B-=S,D-=L,m-=y*l,b-=k*l,M-=S*l,A-=L*l,g-=y*r,_-=k*r,C-=S*r,q-=L*r,f-=y*c,T-=k*c,P-=S*c,z-=L*c;F*=2}while(0===v||0===j||0===I||0===O);for(l=F/v,d*=l,m*=3*l,u*=l,g*=3*l,f*=l,l=F/j,w*=l,b*=3*l,x*=l,_*=3*l,T*=l,l=F/I,E*=l,M*=3*l,B*=l,C*=3*l,P*=l,l=F/O,N*=l,A*=3*l,D*=l,q*=3*l,z*=l,v=n[0],j=n[1],I=n[2],O=n[3],s=3*(j-I)+O-v,a=v+I-2*j,t=j-v,o=v,h=0;20>h;h++)l=d+o*u+t*m+a*g+s*f,v+=l,o+=l,s-=l,a+=l,t-=l,l=w+o*x+t*b+a*_+s*T,j+=l,s+=3*l,a-=l+l,t+=l,l=E+o*B+t*M+a*C+s*P,I+=l,s-=3*l,a+=l,l=N+o*D+t*A+a*q+s*z,O+=l,s+=l;n[0]=v,n[1]=j,n[2]=I,n[3]=O}},_pointerBezierValue:{enumerable:!1,value:function(n,e){var s=1-n;return s*s*s*e[0]+3*s*s*n*e[1]+3*s*n*n*e[2]+n*n*n*e[3]}},_calculatePointerVelocity:{enumerable:!1,value:function(n,e){var s,a,t=n.length,o=n[0],p=n[0],l=0;for(a=1;t>a;a++)o>n[a]&&(o=n[a],l=a);if(s=p-o){if(t>5){var i,r,c,h=[];for(a=0;t>a;a++)h[a]={v:e[a],t:(n[a]-o)/s};return i=h[l].v,r=h[0].v,c=[i,(2*i+r)/3,(i+2*r)/3,r],this._fitPointerCurve(c,h),5e3*(this._pointerBezierValue(.8,c)-this._pointerBezierValue(.6,c))/s}return t>1?1e3*(e[0]-e[l])/s:0}return 0}},pointerMotion:{value:function(n){if(defaultEventManager._pointerStorage.isStored(n)){var e={};return Object.defineProperties(e,{_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(n)),this._x=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=defaultEventManager._getPointerVelocityData(n)),this._y=defaultEventManager._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}),{velocity:e}}return void 0}},monitorDOMModificationInEventHandling:{value:!1},domModificationEventHandler:{value:Montage.specialize({handleEvent:{value:function(){throw"DOM Modified"}},captureDOMSubtreeModified:{value:function(){throw"DOMSubtreeModified"}},captureDOMAttrModified:{value:function(){throw"DOMAttrModified"}},captureDOMCharacterDataModified:{value:function(){throw"DOMCharacterDataModified"}}})},handleEvent:{enumerable:!1,value:function(n){this.monitorDOMModificationInEventHandling&&(document.body.addEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0));var e,s,a,t,o,p,l,i,r,c,h,d,m,u,g=n.type,f=n.bubbles;for("DOMContentLoaded"===g&&(e=n.target.defaultView,e&&this._windowsAwaitingFinalRegistration[e.uuid]&&(this._finalizeWindowRegistration(e),n.target.removeEventListener("DOMContentLoaded",this,!0))),u="boolean"!=typeof n.propagationStopped?MutableEvent.fromEvent(n):n,r=Element.isElement(u.target)||u.target instanceof Document||u.target instanceof Window?this._eventPathForDomTarget(u.target):this._eventPathForTarget(u.target),d=u.target.identifier?this.methodNameForCapturePhaseOfEventType(g,u.target.identifier):null,m=u.target.identifier?this.methodNameForBubblePhaseOfEventType(g,u.target.identifier):null,c=this.methodNameForCapturePhaseOfEventType(g),h=this.methodNameForBubblePhaseOfEventType(g),this.delegate&&typeof this.delegate.willDistributeEvent===FUNCTION_TYPE&&this.delegate.willDistributeEvent(u),this._isStoringPointerEvents&&this._pointerStorage.storeEvent(u),u.eventPhase=CAPTURING_PHASE,s=r.length-1;!u.propagationStopped&&(a=r[s]);s--)if(u.currentTarget=a,t=this.registeredEventListenersForEventType_onTarget_(g,a))for(l=Object.keys(t),o=0;t&&!u.immediatePropagationStopped&&(p=t[l[o]]);o++)p.capture&&(i=p.listener,d&&typeof i[d]===FUNCTION_TYPE?i[d](u):typeof i[c]===FUNCTION_TYPE?i[c](u):typeof i.handleEvent===FUNCTION_TYPE?i.handleEvent(u):typeof i!==FUNCTION_TYPE||i.__isConstructor__||i.call(a,u));if(!u.propagationStopped&&(u.eventPhase=AT_TARGET,u.currentTarget=a=u.target,t=this.registeredEventListenersForEventType_onTarget_(g,a)))for(l=Object.keys(t),o=0;t&&!u.immediatePropagationStopped&&(p=t[l[o]]);o++)i=p.listener,p.capture&&(d&&typeof i[d]===FUNCTION_TYPE?i[d](u):typeof i[c]===FUNCTION_TYPE?i[c](u):typeof i.handleEvent===FUNCTION_TYPE?i.handleEvent(u):typeof i===FUNCTION_TYPE&&i.call(a,u)),p.bubble&&(m&&typeof i[m]===FUNCTION_TYPE?i[m](u):typeof i[h]===FUNCTION_TYPE?i[h](u):typeof i.handleEvent===FUNCTION_TYPE?i.handleEvent(u):typeof i===FUNCTION_TYPE&&i.call(a,u));for(u.eventPhase=BUBBLING_PHASE,s=0;f&&!u.propagationStopped&&(a=r[s]);s++)if(u.currentTarget=a,t=this.registeredEventListenersForEventType_onTarget_(g,a))for(l=Object.keys(t),o=0;t&&!u.immediatePropagationStopped&&(p=t[l[o]]);o++)p.bubble&&(i=p.listener,m&&typeof i[m]===FUNCTION_TYPE?i[m](u):typeof i[h]===FUNCTION_TYPE?i[h](u):typeof i.handleEvent===FUNCTION_TYPE?i.handleEvent(u):typeof i===FUNCTION_TYPE&&i.call(a,u));u.eventPhase=NONE,u.currentTarget=null,this._isStoringPointerEvents&&this._pointerStorage.removeEvent(n),this.monitorDOMModificationInEventHandling&&(document.body.removeEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0))}},_prepareComponentsForActivation:{value:function(n){var e,s,a=n,t=a&&a.defaultView?a.defaultView:window,o=t.document?t.document:document,p=!1,l=null;do switch(a&&(s=this.eventHandlerForElement(a),s&&(p||(p=!0,l=this._findActiveTarget(s)),s._preparedForActivationEvents||(s._prepareForActivationEvents(),s._preparedForActivationEvents=!0))),e=a,a){case t:a=null;break;case o:a=t;break;case o.documentElement:a=o;break;default:a=a.parentNode}while(a&&e!==a);l=l||this.application,l!==this.activeTarget&&(this.activeTarget&&this.activeTarget.willSurrenderActiveTarget(l),l.willBecomeActiveTarget(this.activeTarget),this.activeTarget=l,l.didBecomeActiveTarget())}},_findActiveTarget:{value:function(n){for(var e=null,s={};!e&&n&&!(n.uuid in s);)s[n.uuid]=n,n.acceptsActiveTarget?e=n:n=n.nextTarget;return e}},_eventPathForTarget:{enumerable:!1,value:function(n){if(!n)return[];var e=n,s=this.application,a=[],t={};t[n.uuid]=n;do e.uuid in t||(a.push(e),t[e.uuid]=e),e=e.nextTarget,(!e||e.uuid in t)&&(e=s),e&&e.uuid in t&&(e=null);while(e);return a}},_eventPathForDomTarget:{enumerable:!1,value:function(n){if(!n)return[];var e,s=n,a=s&&s.defaultView?s.defaultView:window,t=a.document?a.document:document,o=this.application,p=[];do switch(s!==n&&p.push(s),e=s,s){case o:s=s.parentApplication,s&&(o=s);break;case a:s=o;break;case t:s=a;break;case t.documentElement:s=t;break;default:s=s.parentNode,s||(s=o)}while(s&&e!==s);return p}},_elementEventHandlerByUUID:{enumerable:!1,value:{}},registerEventHandlerForElement:{enumerable:!1,value:function(n,e){var s=this.eventHandlerForElement(e);s&&this.unregisterEventHandlerForElement(e),this._elementEventHandlerByUUID[e.eventHandlerUUID=n.uuid]=n}},unregisterEventHandlerForElement:{enumerable:!1,value:function(n){delete this._elementEventHandlerByUUID[n.eventHandlerUUID],delete n.eventHandlerUUID}},eventHandlerForElement:{enumerable:!1,value:function(n){return this._elementEventHandlerByUUID[n.eventHandlerUUID]}},_activeTarget:{value:null},activeTarget:{get:function(){return this._activeTarget||this.application},set:function(n){n!==this._activeTarget&&(this._activeTarget=n)}}})}