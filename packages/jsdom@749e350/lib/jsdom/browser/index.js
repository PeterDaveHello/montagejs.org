function NOT_IMPLEMENTED(e){return function(){if(!jsdom.debugMode){var t=e?e.raise:this.raise;t.call(this,"error","NOT IMPLEMENTED")}}}function getDefaultParser(){if(defaultParser===null)try{defaultParser=require("htmlparser")}catch(e){try{defaultParser=require("node-htmlparser/lib/node-htmlparser")}catch(t){defaultParser=undefined}}return defaultParser}var http=require("http"),URL=require("url"),HtmlToDom=require("./htmltodom").HtmlToDom,domToHtml=require("./domtohtml").domToHtml,htmlencoding=require("./htmlencoding"),HTMLEncode=htmlencoding.HTMLEncode,HTMLDecode=htmlencoding.HTMLDecode,jsdom=require("../../jsdom"),Contextify=null;try{Contextify=require("contextify")}catch(e){Contextify=function(e){var t=require("vm"),n=t.createContext(e),r=null;return e.run=function(e,r){return t.runInContext(e,n,r)},e.getGlobal=function(){return r||(r=t.runInContext("this",n)),r},e.dispose=function(){r=null,e.run=function(){throw new Error("Called run() after dispose().")},e.getGlobal=function(){throw new Error("Called getGlobal() after dispose().")},e.dispose=function(){throw new Error("Called dispose() after dispose().")}},e}}exports.windowAugmentation=function(e,t){t=t||{};var n=exports.createWindow(e,t);if(!t.document){var r=browserAugmentation(e,t);t.features&&t.features.QuerySelector&&require(__dirname+"/../selectors/index").applyQuerySelectorPrototype(r),t.document=r.HTMLDocument?new r.HTMLDocument(t):new r.Document(t),t.document.write("<html><head></head><body></body></html>")}var i=n.document=t.document;if(i.addEventListener)if(i.readyState=="complete"){var s=i.createEvent("HTMLEvents");s.initEvent("load",!1,!1),n.dispatchEvent(s)}else i.addEventListener("load",function(e){n.dispatchEvent(e)});return n},exports.createWindow=function(e,t){function r(e,t,r,i){var s=e(r,i);return n.push([s,t]),s}function i(e){if(typeof e=="undefined")return;for(var t in n)if(n[t][0]===e){n[t][1].call(this,e),n.splice(t,1);break}}function s(){n.forEach(function(e){e[1].call(this,e[0])}),n=[]}function o(t){var n=(t||{}).url||"file://"+__filename;this.location=URL.parse(n),this.location.reload=NOT_IMPLEMENTED(this),this.location.replace=NOT_IMPLEMENTED(this),this.location.toString=function(){return n};var o=this.console._window=this;this.location.__defineGetter__("hash",function(){return o.location.href.split("#").length>1?"#"+o.location.href.split("#")[1]:""}),this.location.__defineSetter__("hash",function(e){o.location.href=o.location.href.split("#")[0]+e}),this.location.__defineGetter__("search",function(){return o.location.href.split("?").length>1?"?"+o.location.href.match(/\?([^#]+)/)[1]:""}),this.location.__defineSetter__("search",function(e){o.location.href=o.location.href.indexOf("?")>0?o.location.href.replace(/\?([^#]+)/,e):o.location.href.match(/^([^#?]+)/)[0]+e+o.location.hash}),t&&t.document&&(t.document.location=this.location),this.addEventListener=function(){e.Node.prototype.addEventListener.apply(o,arguments)},this.removeEventListener=function(){e.Node.prototype.removeEventListener.apply(o,arguments)},this.dispatchEvent=function(){e.Node.prototype.dispatchEvent.apply(o,arguments)},this.raise=function(){e.Node.prototype.raise.apply(o.document,arguments)},this.setTimeout=function(e,t){return r(setTimeout,clearTimeout,e,t)},this.setInterval=function(e,t){return r(setInterval,clearInterval,e,t)},this.clearInterval=i,this.clearTimeout=i,this.__stopAllTimers=s}var n=[];o.prototype={__proto__:e,_length:0,get length(){return this._length},close:function(){var e=this;(function t(n){var r;if(n.length>0)for(r=0;r<n.length;r++)t(n[r]);n!==e&&n.close()})(this),this.document&&(this.document.body&&(this.document.body.innerHTML=""),this.document.close&&(this.document._listeners=[],this.document.close()),delete this.document),s(),this.dispose()},getComputedStyle:function(e){var t=e.style,n={};for(var r in t)n[r]=t[r];return n.__proto__={getPropertyValue:function(t){return e.style[t]}},n},console:{log:function(e){this._window.raise("log",e)},info:function(e){this._window.raise("info",e)},warn:function(e){this._window.raise("warn",e)},error:function(e){this._window.raise("error",e)}},navigator:{userAgent:"Node.js ("+process.platform+"; U; rv:"+process.version+")",appName:"Node.js jsDom",platform:process.platform,appVersion:process.version},XMLHttpRequest:function(){},name:"nodejs",innerWidth:1024,innerHeight:768,outerWidth:1024,outerHeight:768,pageXOffset:0,pageYOffset:0,screenX:0,screenY:0,screenLeft:0,screenTop:0,scrollX:0,scrollY:0,scrollTop:0,scrollLeft:0,alert:NOT_IMPLEMENTED(),blur:NOT_IMPLEMENTED(),confirm:NOT_IMPLEMENTED(),createPopup:NOT_IMPLEMENTED(),focus:NOT_IMPLEMENTED(),moveBy:NOT_IMPLEMENTED(),moveTo:NOT_IMPLEMENTED(),open:NOT_IMPLEMENTED(),print:NOT_IMPLEMENTED(),prompt:NOT_IMPLEMENTED(),resizeBy:NOT_IMPLEMENTED(),resizeTo:NOT_IMPLEMENTED(),scroll:NOT_IMPLEMENTED(),scrollBy:NOT_IMPLEMENTED(),scrollTo:NOT_IMPLEMENTED(),screen:{width:0,height:0},Image:NOT_IMPLEMENTED()};var u=new o(t);Contextify(u);var a=u.getGlobal();return u.window=u.frames=u.self=u.parent=u.top=a,u};var defaultParser=null,browserAugmentation=exports.browserAugmentation=function(e,t){function u(t,n){var u="",a="",f="",l="HTML",c=!0,h=n.match(r);t._doctype=null;if(h&&h[0])f=h[0];else{var p=n.indexOf(s),d=n.indexOf(o),v;if(p<0||d<0)return;v=n.substr(p,d-p+o.length),h=v.replace(/[\n\r]/g,"").match(i);if(!h)return;f=h[0],h=h[1].split(' "');var m=h.length?h.pop().replace(/"/g,""):"",g=h.length?h.pop().replace(/"/g,""):"";m.indexOf("-//")!==-1&&(u=m),g.indexOf("-//")!==-1&&(u=g),m.indexOf("://")!==-1&&(a=m),g.indexOf("://")!==-1&&(a=g),h.length&&(h=h[0].split(" "),l=h[0].toUpperCase())}t._doctype=(new e.DOMImplementation).createDocumentType(l,u,a),t._doctype._ownerDocument=t,t._doctype._fullDT=f,t._doctype.toString=function(){return this._fullDT}}if(e._augmented)return e;t||(t={});var n=new HtmlToDom(t.parser||getDefaultParser());e.HTMLDocument||(e.HTMLDocument=e.Document),e.HTMLDocument.prototype.write||(e.HTMLDocument.prototype.write=function(e){this.innerHTML=e}),e.Element.prototype.getElementsByClassName=function(t){function n(n){if(!n)return!1;n.nodeType&&n.nodeType===e.Node.ENTITY_REFERENCE_NODE&&(n=n._entity);var r=n.className;if(r){var i=r.split(" ");for(var s=0;s<i.length;s++)if(i[s]===t)return!0}return!1}return new e.NodeList(this.ownerDocument||this,e.mapper(this,n))},e.Element.prototype.__defineGetter__("sourceIndex",function(){var e=this.ownerDocument.getElementsByTagName("*"),t=e.length;for(var n=0;n<t;n++)if(e[n]===this)return n}),e.Document.prototype.__defineGetter__("outerHTML",function(){return domToHtml(this,!0)}),e.Element.prototype.__defineGetter__("outerHTML",function(){return domToHtml(this,!0)}),e.Element.prototype.__defineGetter__("innerHTML",function(){if(/^(?:script|style)$/.test(this._tagName)){var e=this.getAttribute("type");if(!e||/^text\//i.test(e)||/\/javascript$/i.test(e))return domToHtml(this._childNodes,!0,!0)}return domToHtml(this._childNodes,!0)}),e.Element.prototype.__defineSetter__("doctype",function(){throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR)}),e.Element.prototype.__defineGetter__("doctype",function(){var e=null;return this.nodeName=="#document"&&this._doctype&&(e=this._doctype),e}),e.Element.prototype.__defineSetter__("innerHTML",function(e){var t;while(t=this._childNodes[0])this.removeChild(t);return this.nodeName==="#document"&&u(this,e),e!==""&&e!=null&&n.appendHtmlToElement(e,this),e}),e.Document.prototype.__defineGetter__("innerHTML",function(){return domToHtml(this._childNodes,!0)}),e.Document.prototype.__defineSetter__("innerHTML",function(e){var t;while(t=this._childNodes[0])this.removeChild(t);return this.nodeName==="#document"&&u(this,e),e!==""&&e!=null&&n.appendHtmlToElement(e,this),e});var r=/<!doctype html>/i,i=/<!DOCTYPE (\w(.|\n)*)">/i,s="<!DOCTYPE ",o='">';return e.Document.prototype.getElementsByClassName=function(t){function n(n){if(!n)return!1;n.nodeType&&n.nodeType===e.Node.ENTITY_REFERENCE_NODE&&(n=n._entity);var r=n.className;if(r){var i=r.split(" ");for(var s=0;s<i.length;s++)if(i[s]===t)return!0}return!1}return new e.NodeList(this.ownerDocument||this,e.mapper(this,n))},e.Element.prototype.__defineGetter__("nodeName",function(e){return this._nodeName.toUpperCase()}),e.Element.prototype.__defineGetter__("tagName",function(e){var t=this._tagName.toUpperCase();return this.nodeName==="#document"&&(t=null),t}),e.Element.prototype.scrollTop=0,e.Element.prototype.scrollLeft=0,e.Document.prototype.__defineGetter__("parentWindow",function(){if(!this._parentWindow){var t=exports.windowAugmentation(e,{document:this,url:this.URL});this._parentWindow=t.getGlobal()}return this._parentWindow}),e.Document.prototype.__defineSetter__("parentWindow",function(e){this._parentWindow=e.getGlobal()}),e.Document.prototype.__defineGetter__("defaultView",function(){return this.parentWindow}),e._augmented=!0,e}