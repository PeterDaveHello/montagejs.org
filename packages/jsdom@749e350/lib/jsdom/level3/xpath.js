(function(){function s(e,t,n,r){var i=e(t,n);if(i==null)return null;var s;while(s=t.trypop(r)){var o=e(t,n);if(o==null)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected something after "+s);i=n.node(s,i,o)}return i}function o(e,t,n,r){var i=e(t,n);if(i==null)return null;var s=t.trypop(r);if(s){var u=o(t,n);if(u==null)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected something after "+s);return n.node(s,i,u)}return i}function u(e,t){return a(e,t)||f(null,e,t)}function a(e,t){var n=e.peek();if("/"===n||"//"===n){var r=t.node("Root");return f(r,e,t,!0)}return null}function f(e,t,n,r){if(null==e){e=l(t,n);if(null==e)return e}var i;while(i=t.trypop(["/","//"])){"//"===i&&(e=n.node("/",e,n.node("Axis","descendant-or-self","node",undefined)));var s=l(t,n);if(null==s&&"/"===i&&r)return e;r=!1;if(null==s)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected step after "+i);e=n.node("/",e,s)}return e}function l(e,t){var n=e.trypop([".",".."]);if("."===n)return t.node("Axis","self","node");if(".."===n)return t.node("Axis","parent","node");var r=c(e,t),i=h(e,t),s;null==i&&(s=p(e,t));if(null==r&&null==i&&null==s)return null;if(null==i&&null==s)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected nodeTest after axisSpecifier "+r);null==r&&(r="child"),null==i&&("attribute"===r?i="attribute":"namespace"===r?i="namespace":i="element");var o=t.node("Axis",r,i,s),u;while(null!=(u=d(o,e,t)))o=u;return o}function c(e,t){var n=e.trypop("@");if(null!=n)return"attribute";var r=e.trypopaxisname();if(null!=r){var i=e.trypop("::");if(null==i)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Should not happen. Should be ::.");return r}}function h(e,t){if("("!==e.peek2())return null;var n=e.trypop(["comment","text","processing-instruction","node"]);if(null!=n){if(null==e.trypop("("))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Should not happen.");var r=undefined;n=="processing-instruction"&&(r=e.trypopliteral());if(null==e.trypop(")"))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected close parens.");return n}}function p(e,t){var n=e.trypopnametest();return n!=null?n:null}function d(e,t,n){if(null==t.trypop("["))return null;var r=w(t,n);if(null==r)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected expression after [");if(null==t.trypop("]"))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected ] after expression.");return n.node("Predicate",e,r)}function v(e,t){var n=e.trypopliteral();null==n&&(n=e.trypopnumber());if(null!=n)return n;var r=e.trypopvarref();if(null!=r)return t.node("VariableReference",r);var i=m(e,t);if(null!=i)return i;if(e.trypop("(")){var s=w(e,t);if(null==s)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected expression after (.");if(null==e.trypop(")"))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected ) after expression.");return s}return null}function m(e,t){var n=e.trypopfuncname(e,t);if(null==n)return null;if(null==e.trypop("("))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected ( ) after function name.");var r=[],i=!0;while(null==e.trypop(")")){if(!i&&null==e.trypop(","))throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected , between arguments of the function.");i=!1;var s=w(e,t);if(s==null)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected expression as argument of function.");r.push(s)}return t.node("FunctionCall",n,r)}function g(e,t){return s(y,e,t,"|")}function y(e,t){var n=b(e,t);if(null==n){var r=u(e,t);if(null==r)throw new Error;return t.node("PathExpr",r)}var i=f(n,e,t,!1);return n===i?i:t.node("PathExpr",i)}function b(e,t){var n=v(e,t);if(n==null)return null;var r,i=n;while(null!=(r=d(i,e,t)))i=r;return i}function w(e,t){var n=(e.peeked||"")+e.str,r=s(E,e,t,"or"),i=(e.peeked||"")+e.str;return r}function E(e,t){return s(S,e,t,"and")}function S(e,t){return s(x,e,t,["=","!="])}function x(e,t){return s(T,e,t,["<",">","<=",">="])}function T(e,t){return s(N,e,t,["+","-"])}function N(e,t){return s(C,e,t,["*","div","mod"])}function C(e,t){if(e.trypop("-")){var n=C(e,t);if(null==n)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected unary expression after -");return t.node("UnaryMinus",n)}return g(e,t)}function L(e){}function A(e){this.nodes=[],this.pos=[],this.lasts=[],this.nextPos=[],this.seriesIndexes=[],this.isReverseAxis=e,this._pushToNodes=e?Array.prototype.unshift:Array.prototype.push}function O(e){var t=[];for(var n=0;n<e.nodes.length;n++){var r=e.nodes[n];if(!e.pos)t.push({nodes:[r],pos:[[n+1]],lasts:[[e.nodes.length]]});else for(var i=0;i<e.pos[n].length;++i)t.push({nodes:[r],pos:[[e.pos[n][i]]],lasts:[[e.lasts[n][i]]]})}return t}function M(e,t,n){this.nodeTypeNum=e,this.nodeName=t,this.shouldLowerCase=n,this.nodeNameTest=null==t?this._alwaysTrue:n?this._nodeNameLowerCaseEquals:this._nodeNameEquals}function _(e,t,n,r,i,s,o,u,a){var f=new M(t,n,r),l=new A(a);while(0<e.length){var c=i.call(e);console.assert(c!=null),c=o(c),l.pushSeries();var h=1;while(null!=c)!u&&f.matches(c)&&l.addNode(c),c===s.call(e)&&(i.call(e),l.pushSeries(),h++),u&&f.matches(c)&&l.addNode(c),c=o(c);while(0<h--)l.popSeries()}return l}function D(e){if(e.ownerElement){if(e.ownerElement.firstChild)return e.ownerElement.firstChild;e=e.ownerElement}do if(e.nextSibling)return e.nextSibling;while(e=e.parentNode);return null}function P(e){e.ownerElement&&(e=e.ownerElement);if(null!=e.firstChild)return e.firstChild;do{if(null!=e.nextSibling)return e.nextSibling;e=e.parentNode}while(e);return null}function H(e){if(e.ownerElement)return e.ownerElement;if(null!=e.previousSibling){e=e.previousSibling;while(null!=e.lastChild)e=e.lastChild;return e}return null!=e.parentNode?e.parentNode:null}function B(e,t,n,r){var i=new M(t,n,r),s=new A(!1),o=e[0],u=[];for(var a=0;a<e.length;a++){var f=e[a],l=D(f);l&&u.push(l)}if(0===u.length)return{nodes:[]};var c=[],h=[],p=0;while(o=P(o)){for(var a=u.length-1;a>=0;a--)o===u[a]&&(s.pushSeries(),u.splice(a,a+1),p++);p&&i.matches(o)&&s.addNode(o)}console.assert(0===u.length);for(var a=0;a<p;a++)s.popSeries();return s.finalize()}function j(e,t,n,r){var i=new M(t,n,r),s=e.pop();if(null==s)return{nodes:{}};var o={nodes:[],pos:[],lasts:[]},u=[s.parentNode||s.ownerElement],a=[1];while(s=H(s)){s===e[e.length-1]&&(u.push(e.pop()),a.push(1));var f=i.matches(s),l,c=!1;f&&(l=a.slice());for(var h=0;h<u.length;++h)s===u[h]?(u[h]=s.parentNode||s.ownerElement,f&&(l[h]=null)):f&&(l[h]=a[h]++,c=!0);c&&(o.nodes.unshift(s),o.pos.unshift(l))}for(var h=0;h<o.pos.length;++h){var p=[];o.lasts.push(p);for(var d=o.pos[h].length-1;d>=0;d--)null==o.pos[h][d]?o.pos[h].splice(d,d+1):p.unshift(a[d]-1)}return o}function F(e,t,n,r,i,s,o){while(0<n.length&&null!=n[0].ownerElement){var u=n.shift();i&&r.matches(u)&&(o.push(u),s.push(e.nodes.length))}null!=t&&!i&&r.matches(t)&&e.addNode(t);var a=!1;if(null==t){if(0===n.length)return;t=n.shift(),e.pushSeries(),a=!0}else 0<n.length&&t===n[0]&&(e.pushSeries(),a=!0,n.shift());i&&r.matches(t)&&e.addNode(t);var f=t.childNodes;for(var l=0;l<f.length;++l){var c=f[l];F(e,c,n,r,i,s,o)}a&&e.popSeries()}function I(e,t,n,r,i){var s=new M(t,n,r),o=new A(!1),u=[],a=[];while(0<e.length)F(o,null,e,s,i,u,a);o.finalize();for(var f=a.length-1;f>=0;--f)o.nodes.splice(u[f],u[f],a[f]),o.pos.splice(u[f],u[f],[1]),o.lasts.splice(u[f],u[f],[1]);return o}function q(e,t,n,r,i){var s=new M(t,n,r),o=[];for(var u=0;u<e.length;++u){var a=e[u],f=!0,l=[];while(null!=a)(!f||i)&&s.matches(a)&&l.push(a),f=!1,a=a.parentNode||a.ownerElement;0<l.length&&o.push(l)}var c=[];for(var u=0;u<o.length;++u)c.push(o[u].length);var h=new A(!0),p={nodes:[],pos:[],lasts:[]};while(0<o.length){var d=[o[0].length],v=[c[0]],a=o[0].pop();for(var u=o.length-1;u>0;--u)a===o[u][o[u].length-1]&&(d.push(o[u].length),v.push(c[u]),o[u].pop(),0===o[u].length&&(o.splice(u,u+1),c.splice(u,u+1)));0===o[0].length&&(o.shift(),c.shift()),p.nodes.push(a),p.pos.push(d),p.lasts.push(v)}return p}function R(e){var t=[e];null!=e.ownerElement&&(e=e.ownerElement,t.push(-1));while(null!=e){var n=0;while(null!=e.previousSibling)e=e.previousSibling,n++;t.push(n),e=e.parentNode}return t}function U(e,t){var n=Math.min(e.length-1,t.length-1),r=e.length,i=t.length;if(e[0]===t[0])return 0;var s;for(var o=0;o<n;++o){s=e[r-o-1]-t[i-o-1];if(0!==s)break}if(null==s||0===s)s=r-i;return 0===s&&(s=e.nodeName-t.nodeName),0===s&&(s=1),s}function W(e){function s(e,t){return U(e.v,t.v)}var t=[];for(var n=0;n<e.nodes.length;n++){var r=R(e.nodes[n]);t.push({v:r,n:e.nodes[n],p:e.pos[n],l:e.lasts[n]})}t.sort(s);var i={nodes:[],pos:[],lasts:[]};for(var n=0;n<t.length;++n)i.nodes.push(t[n].n),i.pos.push(t[n].p),i.lasts.push(t[n].l);return i}function X(e){var t=[e],n=e;while(n=n.parentNode||n.ownerElement)t.unshift(n);return t}function V(e,n){if(e===n)return 0;var r=e;while(r=r.previousSibling)if(r===n)return 1;r=n;while(r=r.previousSibling)if(r===e)return-1;throw new Error("a and b are not siblings: "+t.stringifyObject(e)+" vs "+t.stringifyObject(n))}function $(e,t){var n,r,i,s,o=[];if("object"!=typeof e)throw new nt(nt.INVALID_EXPRESSION_ERR,"Invalid LHS for | operator (expected node-set): "+e);if("object"!=typeof t)throw new nt(nt.INVALID_EXPRESSION_ERR,"Invalid LHS for | operator (expected node-set): "+t);for(;;){null==n&&(n=e.shift(),null!=n&&(i=R(n))),null==r&&(r=t.shift(),null!=r&&(s=R(r)));if(null==n||null==r)break;var u=U(i,s);u<0?(o.push(n),n=null,i=null):u>0?(o.push(r),r=null,s=null):n.nodeName<r.nodeName?(o.push(n),n=null,i=null):n.nodeName>r.nodeName?(o.push(r),r=null,s=null):n!==r?(o.push(r),r=null,s=null):(console.assert(n===r,u),r=null,s=null)}while(n)o.push(n),n=e.shift();while(r)o.push(r),r=t.shift();return o}function J(e,t,n,r){var i;r?i=Q.number:i="boolean"==typeof t||"boolean"==typeof n?Q["boolean"]:"number"==typeof t||"number"==typeof n?Q.number:Q.string;if("object"==typeof t&&"object"==typeof n){var s={};for(var o=0;o<t.nodes.length;++o){var u=i({nodes:[t.nodes[o]]});for(var a=0;a<n.nodes.length;++a){var f=i({nodes:[n.nodes[a]]});if(e(u,f))return!0}}return!1}if("object"==typeof t&&t.nodes&&t.nodes.length){for(var o=0;o<t.nodes.length;++o){var u=i({nodes:[t.nodes[o]]}),l=i(n);if(e(u,l))return!0}return!1}if("object"==typeof n&&t.nodes&&t.nodes.length){for(var o=0;o<t.nodes.length;++o){var c=i({nodes:[n.nodes[o]]}),h=i(t);if(e(h,c))return!0}return!1}var h=i(t),l=i(n);return e(h,l)}var e,t;"function"==typeof require?(e=require("../level3/core").dom.level3.core,t=exports):(e=this,t={});var n=t.Stream=function(t){this.original=this.str=t,this.peeked=null,this.prev=null,this.prevprev=null};n.prototype={peek:function(){if(this.peeked)return this.peeked;var e=this.re.exec(this.str);return e?(this.str=this.str.substr(e[0].length),this.peeked=e[1]):null},peek2:function(){this.peek();var e=this.re.exec(this.str);return e?e[1]:null},pop:function(){var e=this.peek();return this.peeked=null,this.prevprev=this.prev,this.prev=e,e},trypop:function(e){var t=this.peek();if(t===e)return this.pop();if(Array.isArray(e))for(var n=0;n<e.length;++n){var r=e[n];if(r==t)return this.pop()}},trypopfuncname:function(){var e=this.peek();if(!this.isQnameRe.test(e))return null;switch(e){case"comment":case"text":case"processing-instruction":case"node":return null}return"("!=this.peek2()?null:this.pop()},trypopaxisname:function(){var e=this.peek();switch(e){case"ancestor":case"ancestor-or-self":case"attribute":case"child":case"descendant":case"descendant-or-self":case"following":case"following-sibling":case"namespace":case"parent":case"preceding":case"preceding-sibling":case"self":if("::"==this.peek2())return this.pop()}return null},trypopnametest:function(){var e=this.peek();return"*"===e||this.startsWithNcNameRe.test(e)?this.pop():null},trypopliteral:function(){var e=this.peek();if(null==e)return null;var t=e.charAt(0),n=e.charAt(e.length-1);if('"'===t&&'"'===n||"'"===t&&"'"===n)return this.pop(),e.substr(1,e.length-2)},trypopnumber:function(){var e=this.peek();return this.isNumberRe.test(e)?parseFloat(this.pop()):null},trypopvarref:function(){var e=this.peek();return null==e?null:"$"===e.charAt(0)?this.pop().substr(1):null},position:function(){return this.original.length-this.str.length}},function(){var e="A-Z_a-zÀ-ÖØ-öø-˿Ͱ-ͽͿ-῿‌-‍⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�",t=e+"\\-\\.0-9·̀-ͯ‿-⁀",r="["+e+"]["+t+"]*",i=r+"(?::"+r+")?",s="\\.\\.|[\\(\\)\\[\\].@,]|::",o="and|or|mod|div|//|!=|<=|>=|[*/|+\\-=<>]",u="\"[^\"]*\"|'[^']*'",a="[0-9]+(?:\\.[0-9]*)?|\\.[0-9]+",f="\\$"+i,l="\\*|"+r+":\\*|"+i,c="[ 	\r\n]*",h="comment|text|processing-instruction|node",p=new RegExp("^"+c+"("+a+"|"+s+"|"+l+"|"+o+"|"+u+"|"+f+")");n.prototype.re=p,n.prototype.startsWithNcNameRe=new RegExp("^"+r),n.prototype.isQnameRe=new RegExp("^"+i+"$"),n.prototype.isNumberRe=new RegExp("^"+a+"$")}();var i=t.parse=function(t,n){var r=w(t,n),i,s=[];while(i=t.pop())s.push(i);if(s.length)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Unparsed tokens: "+s.join(" "));return r},k={node:function(){return Array.prototype.slice.call(arguments)}};A.prototype={pushSeries:function(){this.nextPos.push(1),this.seriesIndexes.push(this.nodes.length)},popSeries:function(){console.assert(0<this.nextPos.length,this.nextPos);var t=this.nextPos.pop()-1,n=this.nextPos.length,r=this.seriesIndexes.pop(),i=this.nodes.length;for(var s=r;s<i;++s)console.assert(n<this.lasts[s].length),console.assert(undefined===this.lasts[s][n]),this.lasts[s][n]=t},finalize:function(){if(null==this.nextPos)return this;console.assert(0===this.nextPos.length);for(var e=0;e<this.lasts.length;++e)for(var t=0;t<this.lasts[e].length;++t)console.assert(null!=this.lasts[e][t],e+","+t+":"+JSON.stringify(this.lasts));return this.pushSeries=this.popSeries=this.addNode=function(){throw new Error("Already finalized.")},this},addNode:function(t){console.assert(t),this._pushToNodes.call(this.nodes,t),this._pushToNodes.call(this.pos,this.nextPos.slice()),this._pushToNodes.call(this.lasts,new Array(this.nextPos.length));for(var n=0;n<this.nextPos.length;++n)this.nextPos[n]++},simplify:function(){return this.finalize(),{nodes:this.nodes,pos:this.pos,lasts:this.lasts}}},M.prototype={matches:function(t){return(0===this.nodeTypeNum||t.nodeType===this.nodeTypeNum)&&this.nodeNameTest(t.nodeName)},_alwaysTrue:function(e){return!0},_nodeNameEquals:function(t){return this.nodeName===t},_nodeNameLowerCaseEquals:function(t){return this.nodeName===t.toLowerCase()}};var z=t.sortUniqDocumentOrder=function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n],i=R(r);t.push(i)}t.sort(U);var s=[];for(var n=0;n<t.length;n++){if(0<n&&t[n][0]===t[n-1][0])continue;s.push(t[n][0])}return s},K=t.axes={ancestor:function(t,n,r,i){return q(t,n,r,i,!1)},"ancestor-or-self":function(t,n,r,i){return q(t,n,r,i,!0)},attribute:function(t,n,r,i){var s=new M(n,r,i),o=new A(!1);if(null!=r)for(var u=0;u<t.length;++u){var a=t[u];if(null==a.getAttributeNode)continue;var f=a.getAttributeNode(r);null!=f&&s.matches(f)&&(o.pushSeries(),o.addNode(f),o.popSeries())}else for(var u=0;u<t.length;++u){var a=t[u];if(null!=a.attributes){o.pushSeries();for(var l=0;l<a.attributes.length;l++){var f=a.attributes[l];s.matches(f)&&o.addNode(f)}o.popSeries()}}return o.finalize()},child:function ot(e,t,n,i){var s=new M(t,n,i),o=new A(!1);for(var u=0;u<e.length;++u){var a=e[u];if(a.ownerElement)continue;if(a.childNodes){o.pushSeries();var f=1===t&&null!=a.children?a.children:a.childNodes;for(var l=0;l<f.length;++l){var ot=f[l];s.matches(ot)&&o.addNode(ot)}o.popSeries()}}return o.finalize(),r=W(o),r},descendant:function(t,n,r,i){return I(t,n,r,i,!1)},"descendant-or-self":function(t,n,r,i){return I(t,n,r,i,!0)},following:function(t,n,r,i){return B(t,n,r,i)},"following-sibling":function(t,n,r,i){return _(t,n,r,i,Array.prototype.shift,function(){return this[0]},function(e){return e.nextSibling})},namespace:function(t,n,r,i){},parent:function ut(e,t,n,r){var i=new M(t,n,r),s=[],o=[];for(var u=0;u<e.length;++u){var ut=e[u].parentNode||e[u].ownerElement;if(null==ut)continue;if(!i.matches(ut))continue;if(s.length>0&&ut===s[s.length-1])continue;s.push(ut),o.push([1])}return{nodes:s,pos:o,lasts:o}},preceding:function(t,n,r,i){return j(t,n,r,i)},"preceding-sibling":function(t,n,r,i){return _(t,n,r,i,Array.prototype.pop,function(){return this[this.length-1]},function(e){return e.previousSibling},!1,!0)},self:function(t,n,r,i){var s=[],o=[],u=new M(n,r,i);for(var a=0;a<t.length;++a)u.matches(t[a])&&(s.push(t[a]),o.push([1]));return{nodes:s,pos:o,lasts:o}}},Q={number:function(t){return"number"==typeof t?t:"string"==typeof t?parseFloat(t):"boolean"==typeof t?+t:Q.number(Q.string.call(this,t))},string:function(t){return null==t?Q.string(this):"string"==typeof t||"boolean"==typeof t||"number"==typeof t?""+t:0==t.nodes.length?"":null!=t.nodes[0].textContent?t.nodes[0].textContent:t.nodes[0].nodeValue},"boolean":function(t){return"object"==typeof t?t.nodes.length>0:!!t},last:function(){return console.assert(Array.isArray(this.pos)),console.assert(Array.isArray(this.lasts)),console.assert(1===this.pos.length),console.assert(1===this.lasts.length),console.assert(1===this.lasts[0].length),this.lasts[0][0]},position:function(){return console.assert(Array.isArray(this.pos)),console.assert(Array.isArray(this.lasts)),console.assert(1===this.pos.length),console.assert(1===this.lasts.length),console.assert(1===this.pos[0].length),this.pos[0][0]},count:function(t){if("object"!=typeof t)throw new nt(nt.INVALID_EXPRESSION_ERR,"Position "+stream.position()+": Function count(node-set) "+"got wrong argument type: "+t);return t.nodes.length},id:function at(e){var t={nodes:[]},n=this.nodes[0].ownerDocument||this.nodes[0];console.assert(n);var r;if("object"==typeof e){r=[];for(var i=0;i<e.nodes.length;++i){var s=e.nodes[i],o=Q.string({nodes:[s]}),u=o.split(/[ \t\r\n]+/g);Array.prototype.push.apply(r,u)}}else{var o=Q.string(e),u=o.split(/[ \t\r\n]+/g);r=u}for(var i=0;i<r.length;++i){var at=r[i];if(0===at.length)continue;var a=n.getElementById(at);null!=a&&t.nodes.push(a)}return t.nodes=z(t.nodes),t},"local-name":function(e){if(null==e)return Q.name(this);if(null==e.nodes)throw new nt(nt.INVALID_EXPRESSION_ERR,"argument to name() must be a node-set. got "+e);return e.nodes[0].nodeName.toLowerCase()},"namespace-uri":function(e){throw new Error("not implemented yet")},name:function(e){if(null==e)return Q.name(this);if(null==e.nodes)throw new nt(nt.INVALID_EXPRESSION_ERR,"argument to name() must be a node-set. got "+e);return e.nodes[0].nodeName.toLowerCase()},concat:function(t){var n=[];for(var r=0;r<arguments.length;++r)n.push(Q.string(arguments[r]));return n.join("")},"starts-with":function(t,n){var r=Q.string(t),i=Q.string(n);return r.substr(0,i.length)===i},contains:function(t,n){var r=Q.string(t),i=Q.string(n),s=r.indexOf(i);return-1===s?!1:!0},"substring-before":function(t,n){var r=Q.string(t),i=Q.string(n),s=r.indexOf(i);return-1===s?"":r.substr(0,s)},"substring-after":function(t,n){var r=Q.string(t),i=Q.string(n),s=r.indexOf(i);return-1===s?"":r.substr(s+i.length)},substring:function(t,n,r){if(null==t||null==n)throw new nt(nt.INVALID_EXPRESSION_ERR,"Must be at least 2 arguments to string()");var i=Q.string(t),s=Q.round(n),o=r==null?null:Q.round(r);return o==null?i.substr(s-1):i.substr(s-1,o)},"string-length":function(t){return Q.string.call(this,t).length},"normalize-space":function(t){var n=Q.string.call(this,t);return n.replace(/[ \t\r\n]+/g," ").replace(/^ | $/g,"")},translate:function(t,n,r){var i=Q.string.call(this,t),s=Q.string(n),o=Q.string(r),u=[],a={};for(var f=0;f<s.length;++f){var l=s.charAt(f);a[l]=o.charAt(f),u.push(l.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08"))}var c=new RegExp(u.join("|"),"g");return i.replace(c,function(e){return a[e]})},not:function(t){var n=Q["boolean"](t);return!n},"true":function(){return!0},"false":function(){return!1},lang:function(t){throw new Error("Not implemented")},sum:function ft(e){if(null==e)return Q.sum(this);var ft=0;for(var t=0;t<e.nodes.length;++t){var n=e.nodes[t],r=Q.number({nodes:[n]});ft+=r}return ft},floor:function(t){return Math.floor(Q.number(t))},ceiling:function(t){return Math.ceil(Q.number(t))},round:function(t){return Math.round(Q.number(t))}},G={UnaryMinus:function(e){return-Q.number(e)},"+":function(e,t){return Q.number(e)+Q.number(t)},"-":function(e,t){return Q.number(e)-Q.number(t)},"*":function(e,t){return Q.number(e)*Q.number(t)},div:function(e,t){return Q.number(e)/Q.number(t)},mod:function(e,t){return Q.number(e)%Q.number(t)},"<":function(e,t){return J(function(e,t){return Q.number(e)<Q.number(t)},e,t,!0)},"<=":function(e,t){return J(function(e,t){return Q.number(e)<=Q.number(t)},e,t,!0)},">":function(e,t){return J(function(e,t){return Q.number(e)>Q.number(t)},e,t,!0)},">=":function(e,t){return J(function(e,t){return Q.number(e)>=Q.number(t)},e,t,!0)},and:function(e,t){return Q["boolean"](e)&&Q["boolean"](t)},or:function(e,t){return Q["boolean"](e)||Q["boolean"](t)},"|":function(e,t){return{nodes:$(e.nodes,t.nodes)}},"=":function(e,t){if("object"==typeof e&&"object"==typeof t){var n={};for(var r=0;r<e.nodes.length;++r){var i=Q.string({nodes:[e.nodes[r]]});n[i]=!0}for(var r=0;r<t.nodes.length;++r){var i=Q.string({nodes:[t.nodes[r]]});if(n[i])return!0}return!1}return J(function(e,t){return e===t},e,t)},"!=":function(e,t){if("object"==typeof e&&"object"==typeof t){if(0===e.nodes.length||0===t.nodes.length)return!1;var n={};for(var r=0;r<e.nodes.length;++r){var i=Q.string({nodes:[e.nodes[r]]});n[i]=!0}for(var r=0;r<t.nodes.length;++r){var i=Q.string({nodes:[t.nodes[r]]});if(!n[i])return!0}return!1}return J(function(e,t){return e!==t},e,t)}},Y=t.nodeTypes={node:0,attribute:2,comment:8,text:3,"processing-instruction":7,element:1},Z=t.stringifyObject=function(t){function r(e){if(Array.isArray(e))return e.map(function(e){return r(e)});if("object"!=typeof e)return e;if(null==e)return e;if(null!=e.outerHTML)return e.outerHTML;if(null!=e.nodeValue)return e.nodeName+"="+e.nodeValue;if(e[n])return"[circular]";e[n]=!0;var t={};for(var i in e){if(n===i)continue;try{t[i]=r(e[i])}catch(s){t[i]="[exception: "+s.message+"]"}}return delete e[n],t}var n="seen"+Math.floor(Math.random()*1e9);return JSON.stringify(r(t))},et=t.Evaluator=function(t){this.doc=t};et.prototype={val:function(t,n){console.assert(n.nodes);if("number"==typeof t||"string"==typeof t)return t;if(G[t[0]]){var r=[];for(var i=1;i<t.length;++i)r.push(this.val(t[i],n));var s=G[t[0]].apply(n,r);return s}switch(t[0]){case"Root":return{nodes:[this.doc]};case"FunctionCall":var o=t[1],u=t[2];if(null==Q[o])throw new nt(nt.INVALID_EXPRESSION_ERR,"Unknown function: "+o);var r=[];for(var i=0;i<u.length;++i)r.push(this.val(u[i],n));var s=Q[o].apply(n,r);return s;case"Predicate":var a=this.val(t[1],n),f={nodes:[]},l=O(a);for(var i=0;i<l.length;++i){var c=l[i],h=this.val(t[2],c),p;"number"==typeof h?p=h===c.pos[0][0]:p=Q["boolean"](h);if(p){var d=c.nodes[0];f.nodes.push(d);while(i+1<l.length&&d===l[i+1].nodes[0])i++}}return f;case"PathExpr":var v=this.val(t[1],n);if(v.finalize){for(var i=0;i<v.nodes.length;++i)console.assert(null!=v.nodes[i].nodeType);return{nodes:v.nodes}}return v;case"/":var a=this.val(t[1],n);console.assert(null!=a);var s=this.val(t[2],a);return console.assert(null!=s),s;case"Axis":var m=t[1],g=t[2],y=Y[g],b=!0,w=t[3]&&b?t[3].toLowerCase():t[3];w=w==="*"?null:w;if("object"!=typeof n)return{nodes:[],pos:[]};var E=n.nodes.slice(),s=K[m](E,y,w,b);return s}}};var tt=t.evaluate=function(t,r,s){var o=new n(t),u=i(o,k),a=(new et(r)).val(u,{nodes:[s]});return a},nt=t.XPathException=function(t,n){var r=new Error(n);this.__proto__=r,this.name="XPathException",this.code=t};nt.prototype=Error.prototype,nt.prototype.__proto__=nt,nt.INVALID_EXPRESSION_ERR=51,nt.TYPE_ERR=52;var rt=t.XPathEvaluator=function(){};rt.prototype={createExpression:function(e,t){return new it(e,t)},createNSResolver:function(e){},evaluate:function(t,n,r,i,s){var o=new it(t,r);return o.evaluate(n,i,s)}};var it=t.XPathExpression=function(t,r,s){var o=new n(t);this._ast=i(o,k),this._doc=s};it.prototype={evaluate:function(n,r,i){if(null==n.nodeType)throw new Error("bad argument (expected context node): "+n);var s=n.ownerDocument||n;if(null!=this._doc&&this._doc!==s)throw new e.DOMException(e.WRONG_DOCUMENT_ERR,"The document must be the same as the context node's document.");var o=new et(s),u=o.val(this._ast,{nodes:[n]});if(st.NUMBER_TYPE===r)u=Q.number(u);else if(st.STRING_TYPE===r)u=Q.string(u);else if(st.BOOLEAN_TYPE===r)u=Q["boolean"](u);else{if(st.ANY_TYPE!==r&&st.UNORDERED_NODE_ITERATOR_TYPE!==r&&st.ORDERED_NODE_ITERATOR_TYPE!==r&&st.UNORDERED_NODE_SNAPSHOT_TYPE!==r&&st.ORDERED_NODE_SNAPSHOT_TYPE!==r&&st.ANY_UNORDERED_NODE_TYPE!==r&&st.FIRST_ORDERED_NODE_TYPE!==r)throw new e.DOMException(e.NOT_SUPPORTED_ERR,"You must provide an XPath result type (0=any).");if(st.ANY_TYPE!==r&&"object"!=typeof u)throw new nt(nt.TYPE_ERR,"Value should be a node-set: "+u)}return new st(s,u,r)}};var st=t.XPathResult=function lt(e,t,n){this._value=t,this._resultType=n,this._i=0,this._invalidated=!1;if(this.resultType===lt.UNORDERED_NODE_ITERATOR_TYPE||this.resultType===lt.ORDERED_NODE_ITERATOR_TYPE){e.addEventListener("DOMSubtreeModified",i,!0);var r=this;function i(){r._invalidated=!0,e.removeEventListener("DOMSubtreeModified",i,!0)}}};st.ANY_TYPE=0,st.NUMBER_TYPE=1,st.STRING_TYPE=2,st.BOOLEAN_TYPE=3,st.UNORDERED_NODE_ITERATOR_TYPE=4,st.ORDERED_NODE_ITERATOR_TYPE=5,st.UNORDERED_NODE_SNAPSHOT_TYPE=6,st.ORDERED_NODE_SNAPSHOT_TYPE=7,st.ANY_UNORDERED_NODE_TYPE=8,st.FIRST_ORDERED_NODE_TYPE=9,st.prototype={get resultType(){if(this._resultType)return this._resultType;switch(typeof this._value){case"number":return st.NUMBER_TYPE;case"string":return st.STRING_TYPE;case"boolean":return st.BOOLEAN_TYPE;default:return st.UNORDERED_NODE_ITERATOR_TYPE}},get numberValue(){if(st.NUMBER_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a NUMBER_TYPE.");return this._value},get stringValue(){if(st.STRING_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a STRING_TYPE.");return this._value},get booleanValue(){if(st.BOOLEAN_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a BOOLEAN_TYPE.");return this._value},get singleNodeValue(){if(st.ANY_UNORDERED_NODE_TYPE!==this.resultType&&st.FIRST_ORDERED_NODE_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a FIRST_ORDERED_NODE_TYPE.");return this._value.nodes[0]||null},get invalidIteratorState(){return st.UNORDERED_NODE_ITERATOR_TYPE!==this.resultType&&st.ORDERED_NODE_ITERATOR_TYPE!==this.resultType?!1:!!this._invalidated},get snapshotLength(){if(st.UNORDERED_NODE_SNAPSHOT_TYPE!==this.resultType&&st.ORDERED_NODE_SNAPSHOT_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a ORDERED_NODE_SNAPSHOT_TYPE.");return this._value.nodes.length},iterateNext:function(){if(st.UNORDERED_NODE_ITERATOR_TYPE!==this.resultType&&st.ORDERED_NODE_ITERATOR_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a ORDERED_NODE_ITERATOR_TYPE.");if(this.invalidIteratorState)throw new e.DOMException(e.INVALID_STATE_ERR,"The document has been mutated since the result was returned");return this._value.nodes[this._i++]||null},snapshotItem:function(t){if(st.UNORDERED_NODE_SNAPSHOT_TYPE!==this.resultType&&st.ORDERED_NODE_SNAPSHOT_TYPE!==this.resultType)throw new nt(nt.TYPE_ERR,"You should have asked for a ORDERED_NODE_SNAPSHOT_TYPE.");return this._value.nodes[t]||null}},st.prototype.__proto__=st,e.XPathException=nt,e.XPathExpression=it,e.XPathResult=st,e.XPathEvaluator=rt,e.Document.prototype.createExpression=rt.prototype.createExpression,e.Document.prototype.createNSResolver=rt.prototype.createNSResolver,e.Document.prototype.evaluate=rt.prototype.evaluate})()