function getDocument(e){return e.nodeType==core.Node.DOCUMENT_NODE?e:e._ownerDocument}function mutationEventsEnabled(e){return e.nodeType!=core.Node.ATTRIBUTE_NODE&&getDocument(e).implementation.hasFeature("MutationEvents")}function dispatchAttrEvent(e){return function(t,n,r){var i=this._parentNode,s=t.apply(this,n);if(mutationEventsEnabled(i)){var o=i._ownerDocument,u=events.MutationEvent.prototype[e],a=s&&s.name||r.name,f=s&&s.value||null,l=e=="ADDITION"?r.value:null,c;if(!l||l!=f)c=o.createEvent("MutationEvents"),c.initMutationEvent("DOMAttrModified",!0,!1,i,f,l,a,u),i.dispatchEvent(c)}return s}}var core=require("./core").dom.level2.core,utils=require("../utils");core=Object.create(core);var events={};events.EventException=function(){arguments.length>0?this._code=arguments[0]:this._code=0,arguments.length>1?this._message=arguments[1]:this._message="Unspecified event type",Error.call(this,this._message),Error.captureStackTrace&&Error.captureStackTrace(this,events.EventException)},events.EventException.prototype={UNSPECIFIED_EVENT_TYPE_ERR:0,get code(){return this._code}},events.EventException.prototype.__proto__=Error.prototype,events.Event=function(e){this._eventType=e,this._type=null,this._bubbles=null,this._cancelable=null,this._target=null,this._currentTarget=null,this._eventPhase=null,this._timeStamp=null,this._preventDefault=!1,this._stopPropagation=!1},events.Event.prototype={initEvent:function(e,t,n){this._type=e,this._bubbles=t,this._cancelable=n},preventDefault:function(){this._cancelable&&(this._preventDefault=!0)},stopPropagation:function(){this._stopPropagation=!0},CAPTURING_PHASE:1,AT_TARGET:2,BUBBLING_PHASE:3,get eventType(){return this._eventType},get type(){return this._type},get bubbles(){return this._bubbles},get cancelable(){return this._cancelable},get target(){return this._target},get currentTarget(){return this._currentTarget},get eventPhase(){return this._eventPhase},get timeStamp(){return this._timeStamp}},events.UIEvent=function(e){events.Event.call(this,e),this.view=null,this.detail=null},events.UIEvent.prototype={initUIEvent:function(e,t,n,r,i){this.initEvent(e,t,n),this.view=r,this.detail=i}},events.UIEvent.prototype.__proto__=events.Event.prototype,events.MouseEvent=function(e){events.UIEvent.call(this,e),this.screenX=null,this.screenY=null,this.clientX=null,this.clientY=null,this.ctrlKey=null,this.shiftKey=null,this.altKey=null,this.metaKey=null,this.button=null,this.relatedTarget=null},events.MouseEvent.prototype={initMouseEvent:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){this.initUIEvent(e,t,n,r,i),this.screenX=s,this.screenY=o,this.clientX=u,this.clientY=a,this.ctrlKey=f,this.shiftKey=c,this.altKey=l,this.metaKey=h,this.button=p,this.relatedTarget=d}},events.MouseEvent.prototype.__proto__=events.UIEvent.prototype,events.MutationEvent=function(e){events.Event.call(this,e),this.relatedNode=null,this.prevValue=null,this.newValue=null,this.attrName=null,this.attrChange=null},events.MutationEvent.prototype={initMutationEvent:function(e,t,n,r,i,s,o,u){this.initEvent(e,t,n),this.relatedNode=r,this.prevValue=i,this.newValue=s,this.attrName=o,this.attrChange=u},MODIFICATION:1,ADDITION:2,REMOVAL:3},events.MutationEvent.prototype.__proto__=events.Event.prototype,events.EventTarget=function(){},events.EventTarget.getListeners=function(t,n,r){var i=t._listeners&&t._listeners[n]&&t._listeners[n][r]||[];if(!r){var s=t["on"+n];if(s){var o=t._ownerDocument?t._ownerDocument.implementation:t.document.implementation;o.hasFeature("ProcessExternalResources","script")&&i.push(s)}}return i},events.EventTarget.dispatch=function(t,n,r){var i,s,o=n();while(o&&!t._stopPropagation){i=events.EventTarget.getListeners(o,t._type,r),s=i.length;while(s--){t._currentTarget=o;try{i[s].call(o,t)}catch(u){o.raise("error","Dispatching event '"+t._type+"' failed",{error:u,event:t})}}o=n()}return!t._stopPropagation},events.EventTarget.forwardIterator=function(t){var n=0,r=t.length;return function(){return n<r?t[n++]:null}},events.EventTarget.backwardIterator=function(t){var n=t.length;return function(){return n>=0?t[--n]:null}},events.EventTarget.singleIterator=function(t){var n=1;return function(){return n--?t:null}},events.EventTarget.prototype={addEventListener:function(e,t,n){this._listeners=this._listeners||{};var r=this._listeners[e]||{};n=n===!0;var i=r[n]||[];for(var s=0;s<i.length;s++)if(i[s]===t)return;i.push(t),r[n]=i,this._listeners[e]=r},removeEventListener:function(e,t,n){var r=this._listeners&&this._listeners[e];if(!r)return;var i=r[n===!0];if(!i)return;for(var s=0;s<i.length;s++)if(i[s]===t){i.splice(s,1);return}},dispatchEvent:function(e){if(e==null)throw new events.EventException(0,"Null event");if(e._type==null||e._type=="")throw new events.EventException(0,"Uninitialized event");var t=[];e._target=this;var n=this,r=n._parentNode;while(r)t.push(r),n=r,r=n._parentNode;r=n._parentWindow,r&&t.push(r);var i=events.EventTarget.backwardIterator(t);e._eventPhase=e.CAPTURING_PHASE;if(!events.EventTarget.dispatch(e,i,!0))return e._preventDefault;i=events.EventTarget.singleIterator(e._target),e._eventPhase=e.AT_TARGET;if(!events.EventTarget.dispatch(e,i,!1))return e._preventDefault;if(e._bubbles&&!e._stopPropagation){var s=0;i=events.EventTarget.forwardIterator(t),e._eventPhase=e.BUBBLING_PHASE,events.EventTarget.dispatch(e,i,!1)}return e._preventDefault}},core.Node.prototype.__proto__=events.EventTarget.prototype,utils.intercept(core.Node,"insertBefore",function(e,t,n,r){var i=e.apply(this,t);if(mutationEventsEnabled(this)){var s=getDocument(this),o=s.createEvent("MutationEvents");o.initMutationEvent("DOMNodeInserted",!0,!1,this,null,null,null,null),n.dispatchEvent(o);if(this.nodeType==core.Node.DOCUMENT_NODE||this._attachedToDocument)o=s.createEvent("MutationEvents"),o.initMutationEvent("DOMNodeInsertedIntoDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(e){e.nodeType==core.Node.ELEMENT_NODE&&(e.dispatchEvent(o),e._attachedToDocument=!0)})}return i}),utils.intercept(core.Node,"removeChild",function(e,t,n){if(mutationEventsEnabled(this)){var r=getDocument(this),i=r.createEvent("MutationEvents");i.initMutationEvent("DOMNodeRemoved",!0,!1,this,null,null,null,null),n.dispatchEvent(i),i=r.createEvent("MutationEvents"),i.initMutationEvent("DOMNodeRemovedFromDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(e){e.nodeType==core.Node.ELEMENT_NODE&&(e.dispatchEvent(i),e._attachedToDocument=!1)})}return e.apply(this,t)}),utils.intercept(core.AttrNodeMap,"removeNamedItem",dispatchAttrEvent("REMOVAL")),utils.intercept(core.AttrNodeMap,"setNamedItem",dispatchAttrEvent("ADDITION")),core.CharacterData.prototype.__defineGetter__("_nodeValue",function(){return this.__nodeValue}),core.CharacterData.prototype.__defineSetter__("_nodeValue",function(e){var t=this.__nodeValue;this.__nodeValue=e;if(this._ownerDocument&&this._parentNode&&mutationEventsEnabled(this)){var n=this._ownerDocument.createEvent("MutationEvents");n.initMutationEvent("DOMCharacterDataModified",!0,!1,this,t,e,null,null),this.dispatchEvent(n)}}),core.Document.prototype.createEvent=function(e){switch(e){case"MutationEvents":return new events.MutationEvent(e);case"UIEvents":return new events.UIEvent(e);case"MouseEvents":return new events.MouseEvent(e);case"HTMLEvents":return new events.Event(e)}return new events.Event(e)},exports.dom={level2:{core:core,events:events}}