var util=require("util"),fs=require("fs"),htmlparser=require("./new/htmlparser"),testFolder="./tests",chunkSize=5,testFiles=fs.readdirSync(testFolder),testCount=0,failedCount=0;for(var i in testFiles){testCount++;var fileParts=testFiles[i].split(".");fileParts.pop();var moduleName=fileParts.join("."),test=require(testFolder+"/"+moduleName),handlerCallback=function(t){t&&util.puts("Handler error: "+t)},handler=test.type=="rss"?new htmlparser.RssHandler(handlerCallback,test.options.handler):new htmlparser.DefaultHandler(handlerCallback,test.options.handler),parser=new htmlparser.Parser(handler,test.options.parser);parser.parseComplete(test.html);var resultComplete=handler.dom,chunkPos=0;parser.reset();while(chunkPos<test.html.length)parser.parseChunk(test.html.substring(chunkPos,chunkPos+chunkSize)),chunkPos+=chunkSize;parser.done();var resultChunk=handler.dom,testResult=util.inspect(resultComplete,!1,null)===util.inspect(test.expected,!1,null)&&util.inspect(resultChunk,!1,null)===util.inspect(test.expected,!1,null);util.puts("["+test.name+"]: "+(testResult?"passed":"FAILED")),testResult||(failedCount++,util.puts("== Complete =="),util.puts(util.inspect(resultComplete,!1,null)),util.puts("== Chunked =="),util.puts(util.inspect(resultChunk,!1,null)),util.puts("== Expected =="),util.puts(util.inspect(test.expected,!1,null)))}util.puts("Total tests: "+testCount),util.puts("Failed tests: "+failedCount)