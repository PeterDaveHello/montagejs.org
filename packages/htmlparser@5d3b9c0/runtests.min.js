var sys=require("sys"),fs=require("fs"),htmlparser=require("./lib/htmlparser.min"),testFolder="./tests",chunkSize=5,testFiles=fs.readdirSync(testFolder),testCount=0,failedCount=0;for(var i in testFiles){testCount++;var fileParts=testFiles[i].split(".");fileParts.pop();var moduleName=fileParts.join("."),test=require(testFolder+"/"+moduleName),handlerCallback=function(t){t&&sys.puts("Handler error: "+t)},handler=test.type=="rss"?new htmlparser.RssHandler(handlerCallback,test.options.handler):new htmlparser.DefaultHandler(handlerCallback,test.options.handler),parser=new htmlparser.Parser(handler,test.options.parser);parser.parseComplete(test.html);var resultComplete=handler.dom,chunkPos=0;parser.reset();while(chunkPos<test.html.length)parser.parseChunk(test.html.substring(chunkPos,chunkPos+chunkSize)),chunkPos+=chunkSize;parser.done();var resultChunk=handler.dom,testResult=sys.inspect(resultComplete,!1,null)===sys.inspect(test.expected,!1,null)&&sys.inspect(resultChunk,!1,null)===sys.inspect(test.expected,!1,null);sys.puts("["+test.name+"]: "+(testResult?"passed":"FAILED")),testResult||(failedCount++,sys.puts("== Complete =="),sys.puts(sys.inspect(resultComplete,!1,null)),sys.puts("== Chunked =="),sys.puts(sys.inspect(resultChunk,!1,null)),sys.puts("== Expected =="),sys.puts(sys.inspect(test.expected,!1,null)))}sys.puts("Total tests: "+testCount),sys.puts("Failed tests: "+failedCount)