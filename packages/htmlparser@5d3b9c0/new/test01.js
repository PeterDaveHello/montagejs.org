function parse(e){switch(e.mode){case Mode.Text:return parseText(e);case Mode.Tag:return parseTag(e);case Mode.Attr:return parseAttr(e);case Mode.CData:return parseCData(e);case Mode.Comment:return parseComment(e)}}function parseText(e){var t=e.data.indexOf("<",e.pos),n=t===-1?e.data.substring(e.pos,e.data.length):e.data.substring(e.pos,t);if(t===-1)e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substring(e.pos,e.data.length)),e.pos=e.data.length;else{var n;e.pendingText?(e.pendingText.push(e.data.substring(e.pos,t)),n=e.pendingText.join(""),e.pendingText=null):n=e.data.substring(e.pos,t),e.output.push({type:Mode.Text,data:n}),e.pos=t+1,e.mode=Mode.Tag}}function parseTag(e){re_parseTag.lastIndex=e.pos;var t=re_parseTag.exec(e.data);if(t){if(t[2].substr(0,3)==="!--"){e.mode=Mode.Comment,e.pos+=3;return}if(t[2].substr(0,8)==="![CDATA["){e.mode=Mode.CData,e.pos+=8;return}var n;t[4]===">"?(e.mode=Mode.Text,n=t[0].substr(0,t[0].length-1)):(e.mode=Mode.Attr,n=t[0]),e.pos+=t[0].length;var r={type:Mode.Tag,name:t[2].toLowerCase(),name_raw:t[2],raw:n};e.mode===Mode.Attr&&(e.lastTag=r),e.output.push(r)}else e.needData=!0}function parseAttr_findName(e){re_parseAttr_findName.lastIndex=e.pos;var t=re_parseAttr_findName.exec(e.data);return t?e.pos+t[0].length!==re_parseAttr_findName.lastIndex?null:(e.pos+=t[0].length,e.lastTag.raw+=t[0],t[1]):null}function parseAttr_findValue(e){re_parseAttr_findValue.lastIndex=e.pos;var t=re_parseAttr_findValue.exec(e.data);return t?e.pos+t[0].length!==re_parseAttr_findValue.lastIndex?null:(e.pos+=t[0].length,e.lastTag.raw+=t[0],t[1]||t[2]||t[3]):null}function parseAttr(e){var t=parseAttr_findName(e);if(!t){var n=e.data.indexOf(">",e.pos);n<0?e.needData=!0:(e.lastTag=null,e.pos=n+1,e.mode=Mode.Text);return}e.output.push({type:Mode.Attr,name:t,name_raw:t.toLowerCase(),value:parseAttr_findValue(e)})}function parseCData(e){var t=e.data.indexOf("]]>",e.pos);if(t<0)e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substr(e.pos,e.data.length)),e.pos=e.data.length,e.needData=!0;else{var n;e.pendingText?(e.pendingText.push(e.data.substring(e.pos,t)),n=e.pendingText.join(""),e.pendingText=null):n=e.data.substring(e.pos,t),e.output.push({type:Mode.CData,data:n}),e.mode=Mode.Text,e.pos=t+3}}function parseComment(e){var t=e.data.indexOf("-->",e.pos);if(t<0)e.pendingText||(e.pendingText=[]),e.pendingText.push(e.data.substr(e.pos,e.data.length)),e.pos=e.data.length,e.needData=!0;else{var n;e.pendingText?(e.pendingText.push(e.data.substring(e.pos,t)),n=e.pendingText.join(""),e.pendingText=null):n=e.data.substring(e.pos,t),e.output.push({type:Mode.Comment,data:n}),e.mode=Mode.Text,e.pos=t+3}}var data="starting text\naaa<!--xxx-->bbb\n<![CDATA[This is the CData content]]>\n< htmL >\n    <body>\n        <div style=\"width:100%\"></div>\n        <div name='\"foo\"'>xxx</div>\n        <div bar=baz>yyyyyyyyyyyy</div>\n        <div wrong='<foo>'> zzzz zzz </div>\n        <div a='b' c=d e=\"f\">aaaa</div>\n    </BODY>\n</html>\nending text<unclosed tag='foo' xxx='",Mode={Text:"text",Tag:"tag",Attr:"attr",CData:"cdata",Comment:"comment"},state={mode:Mode.Text,pos:0,data:data,pendingText:null,lastTag:null,needData:!1,output:[]},re_parseTag=/(\s*)([^\s>]+)(\s*)(>?)/g,re_parseAttr_findName=/\s*([^=<>\s'"]+)\s*/g,re_parseAttr_findValue=/\s*=\s*(?:'([^']*)'|"([^"]*)"|([^'"\s>]*))/g;while(state.pos<state.data.length&&!state.needData)parse(state);state.pendingText&&(state.output.push({type:state.mode,data:state.pendingText}),state.pendingText=null),console.log(state);var buffer=[],lastType;for(var i=0,len=state.output.length;i<len;i++){var node=state.output[i];(lastType===Mode.Attr&&node.type!==Mode.Attr||lastType===Mode.Tag&&node.type!==Mode.Attr)&&buffer.push(">");switch(node.type){case Mode.Text:buffer.push(node.data);break;case Mode.Comment:buffer.push("<!--",node.data,"-->");break;case Mode.CData:buffer.push("<![CDATA[",node.data,"]]>");break;case Mode.Tag:buffer.push("<",node.name);break;case Mode.Attr:var quoteChar=node.value.indexOf("'")<0?"'":'"';buffer.push(" ",node.name,"=",quoteChar,node.value,quoteChar)}lastType=node.type}(lastType===Mode.Tag||lastType===Mode.Attr)&&buffer.push(">"),console.log(buffer.join(""))