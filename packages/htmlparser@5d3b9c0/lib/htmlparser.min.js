(function(){function e(e,t){this._options=t?t:{},void 0==this._options.includeLocation&&(this._options.includeLocation=!1),this.validateHandler(e),this._handler=e,this.reset()}function t(e){t.super_.call(this,e,{ignoreWhitespace:!0,verbose:!1,enforceEmptyTags:!1})}function n(e,t){this.reset(),this._options=t?t:{},void 0==this._options.ignoreWhitespace&&(this._options.ignoreWhitespace=!1),void 0==this._options.verbose&&(this._options.verbose=!0),void 0==this._options.enforceEmptyTags&&(this._options.enforceEmptyTags=!0),"function"==typeof e&&(this._callback=e)}if("function"!=typeof require||"object"!=typeof exports||"object"!=typeof module||"string"!=typeof __filename||"string"!=typeof __dirname){if(this.Tautologistics){if(this.Tautologistics.NodeHtmlParser)return}else this.Tautologistics={};this.Tautologistics.NodeHtmlParser={},exports=this.Tautologistics.NodeHtmlParser}var r={Text:"text",Directive:"directive",Comment:"comment",Script:"script",Style:"style",Tag:"tag"};e._reTrim=/(^\s+|\s+$)/g,e._reTrimComment=/(^\!--|--$)/g,e._reWhitespace=/\s/g,e._reTagName=/^\s*(\/?)\s*([^\s\/]+)/,e._reAttrib=/([^=<>\"\'\s]+)\s*=\s*"([^"]*)"|([^=<>\"\'\s]+)\s*=\s*'([^']*)'|([^=<>\"\'\s]+)\s*=\s*([^'"\s]+)|([^=<>\"\'\s\/]+)/g,e._reTags=/[\<\>]/g,e.prototype.parseComplete=function(e){this.reset(),this.parseChunk(e),this.done()},e.prototype.parseChunk=function(e){this._done&&this.handleError(Error("Attempted to parse chunk after parsing already done")),this._buffer+=e,this.parseTags()},e.prototype.done=function(){if(!this._done){this._done=!0;if(this._buffer.length){var t=this._buffer;this._buffer="",t={raw:t,data:this._parseState==r.Text?t:t.replace(e._reTrim,""),type:this._parseState};if(this._parseState==r.Tag||this._parseState==r.Script||this._parseState==r.Style)t.name=this.parseTagName(t.data);this.parseAttribs(t),this._elements.push(t)}this.writeHandler(),this._handler.done()}},e.prototype.reset=function(){this._buffer="",this._done=!1,this._elements=[],this._next=this._current=this._elementsCurrent=0,this._location={row:0,col:0,charOffset:0,inBuffer:0},this._parseState=r.Text,this._prevTagSep="",this._tagStack=[],this._handler.reset()},e.prototype._options=null,e.prototype._handler=null,e.prototype._buffer=null,e.prototype._done=!1,e.prototype._elements=null,e.prototype._elementsCurrent=0,e.prototype._current=0,e.prototype._next=0,e.prototype._location=null,e.prototype._parseState=r.Text,e.prototype._prevTagSep="",e.prototype._tagStack=null,e.prototype.parseTagAttribs=function(e){for(var t=e.length,n=0;n<t;){var i=e[n++];(i.type==r.Tag||i.type==r.Script||i.type==r.style)&&this.parseAttribs(i)}return e},e.prototype.parseAttribs=function(t){if(t.type==r.Script||t.type==r.Style||t.type==r.Tag){var n=t.data.split(e._reWhitespace,1)[0],n=t.data.substring(n.length);if(!(1>n.length)){var i;for(e._reAttrib.lastIndex=0;i=e._reAttrib.exec(n);)void 0==t.attribs&&(t.attribs={}),"string"==typeof i[1]&&i[1].length?t.attribs[i[1]]=i[2]:"string"==typeof i[3]&&i[3].length?t.attribs[i[3].toString()]=i[4].toString():"string"==typeof i[5]&&i[5].length?t.attribs[i[5]]=i[6]:"string"==typeof i[7]&&i[7].length&&(t.attribs[i[7]]=i[7])}}},e.prototype.parseTagName=function(t){return null==t||""==t?"":(t=e._reTagName.exec(t),t?(t[1]?"/":"")+t[2]:"")},e.prototype.parseTags=function(){for(var t=this._buffer.length-1;e._reTags.test(this._buffer);){this._next=e._reTags.lastIndex-1;var n=this._buffer.charAt(this._next),i=this._buffer.substring(this._current,this._next),i={raw:i,data:this._parseState==r.Text?i:i.replace(e._reTrim,""),type:this._parseState},s=this.parseTagName(i.data);if(this._tagStack.length)if(this._tagStack[this._tagStack.length-1]==r.Script){if("/script"==s.toLowerCase())this._tagStack.pop();else if(0!=i.raw.indexOf("!--")&&(i.type=r.Text,this._elements.length&&this._elements[this._elements.length-1].type==r.Text)){var o=this._elements[this._elements.length-1];o.raw=o.data=o.raw+this._prevTagSep+i.raw,i.raw=i.data=""}}else this._tagStack[this._tagStack.length-1]==r.Style?"/style"==s.toLowerCase()?this._tagStack.pop():0!=i.raw.indexOf("!--")&&(i.type=r.Text,this._elements.length&&this._elements[this._elements.length-1].type==r.Text?(o=this._elements[this._elements.length-1],""!=i.raw?(o.raw=o.data=o.raw+this._prevTagSep+i.raw,i.raw=i.data=""):o.raw=o.data=o.raw+this._prevTagSep):""!=i.raw&&(i.raw=i.data=i.raw)):this._tagStack[this._tagStack.length-1]==r.Comment&&(o=i.raw.length,"-"==i.raw.charAt(o-2)&&"-"==i.raw.charAt(o-1)&&">"==n?(this._tagStack.pop(),this._elements.length&&this._elements[this._elements.length-1].type==r.Comment?(o=this._elements[this._elements.length-1],o.raw=o.data=(o.raw+i.raw).replace(e._reTrimComment,""),i.raw=i.data="",i.type=r.Text):i.type=r.Comment):(i.type=r.Comment,this._elements.length&&this._elements[this._elements.length-1].type==r.Comment?(o=this._elements[this._elements.length-1],o.raw=o.data=o.raw+i.raw+n,i.raw=i.data="",i.type=r.Text):i.raw=i.data=i.raw+n));i.type==r.Tag&&(i.name=s,s=s.toLowerCase(),0==i.raw.indexOf("!--")?(i.type=r.Comment,delete i.name,o=i.raw.length,"-"==i.raw.charAt(o-1)&&"-"==i.raw.charAt(o-2)&&">"==n?i.raw=i.data=i.raw.replace(e._reTrimComment,""):(i.raw+=n,this._tagStack.push(r.Comment))):0==i.raw.indexOf("!")||0==i.raw.indexOf("?")?i.type=r.Directive:"script"==s?(i.type=r.Script,"/"!=i.data.charAt(i.data.length-1)&&this._tagStack.push(r.Script)):"/script"==s?i.type=r.Script:"style"==s?(i.type=r.Style,"/"!=i.data.charAt(i.data.length-1)&&this._tagStack.push(r.Style)):"/style"==s&&(i.type=r.Style),i.name&&"/"==i.name.charAt(0))&&(i.data=i.name);if(""!=i.raw||i.type!=r.Text)this._options.includeLocation&&!i.location&&(i.location=this.getLocation(i.type==r.Tag)),this.parseAttribs(i),this._elements.push(i),i.type!=r.Text&&i.type!=r.Comment&&i.type!=r.Directive&&"/"==i.data.charAt(i.data.length-1)&&this._elements.push({raw:"/"+i.name,data:"/"+i.name,name:"/"+i.name,type:i.type});this._parseState="<"==n?r.Tag:r.Text,this._current=this._next+1,this._prevTagSep=n}this._options.includeLocation&&(this.getLocation(),this._location.row+=this._location.inBuffer,this._location.inBuffer=0,this._location.charOffset=0),this._buffer=this._current<=t?this._buffer.substring(this._current):"",this._current=0,this.writeHandler()},e.prototype.getLocation=function(e){for(var t=this._location,n=this._current-(e?1:0),r=e&&0==t.charOffset&&0==this._current;t.charOffset<n;t.charOffset++)e=this._buffer.charAt(t.charOffset),"\n"==e?(t.inBuffer++,t.col=0):"\r"!=e&&t.col++;return{line:t.row+t.inBuffer+1,col:t.col+(r?0:1)}},e.prototype.validateHandler=function(e){if("object"!=typeof e)throw Error("Handler is not an object");if("function"!=typeof e.reset)throw Error("Handler method 'reset' is invalid");if("function"!=typeof e.done)throw Error("Handler method 'done' is invalid");if("function"!=typeof e.writeTag)throw Error("Handler method 'writeTag' is invalid");if("function"!=typeof e.writeText)throw Error("Handler method 'writeText' is invalid");if("function"!=typeof e.writeComment)throw Error("Handler method 'writeComment' is invalid");if("function"!=typeof e.writeDirective)throw Error("Handler method 'writeDirective' is invalid")},e.prototype.writeHandler=function(e){if(!this._tagStack.length||e)for(;this._elements.length;)switch(e=this._elements.shift(),e.type){case r.Comment:this._handler.writeComment(e);break;case r.Directive:this._handler.writeDirective(e);break;case r.Text:this._handler.writeText(e);break;default:this._handler.writeTag(e)}},e.prototype.handleError=function(e){if("function"!=typeof this._handler.error)throw e;this._handler.error(e)},function(e,t){var n=function(){};n.prototype=t.prototype,e.super_=t,e.prototype=new n,e.prototype.constructor=e}(t,n),t.prototype.done=function(){var e={},n,r=i.getElementsByTagName(function(e){return"rss"==e||"feed"==e},this.dom,!1);r.length&&(n=r[0]);if(n){if("rss"==n.name){e.type="rss",n=n.children[0],e.id="";try{e.title=i.getElementsByTagName("title",n.children,!1)[0].children[0].data}catch(s){}try{e.link=i.getElementsByTagName("link",n.children,!1)[0].children[0].data}catch(o){}try{e.description=i.getElementsByTagName("description",n.children,!1)[0].children[0].data}catch(u){}try{e.updated=new Date(i.getElementsByTagName("lastBuildDate",n.children,!1)[0].children[0].data)}catch(a){}try{e.author=i.getElementsByTagName("managingEditor",n.children,!1)[0].children[0].data}catch(l){}e.items=[],i.getElementsByTagName("item",n.children).forEach(function(t){var n={};try{n.id=i.getElementsByTagName("guid",t.children,!1)[0].children[0].data}catch(r){}try{n.title=i.getElementsByTagName("title",t.children,!1)[0].children[0].data}catch(s){}try{n.link=i.getElementsByTagName("link",t.children,!1)[0].children[0].data}catch(o){}try{n.description=i.getElementsByTagName("description",t.children,!1)[0].children[0].data}catch(u){}try{n.pubDate=new Date(i.getElementsByTagName("pubDate",t.children,!1)[0].children[0].data)}catch(a){}e.items.push(n)})}else{e.type="atom";try{e.id=i.getElementsByTagName("id",n.children,!1)[0].children[0].data}catch(c){}try{e.title=i.getElementsByTagName("title",n.children,!1)[0].children[0].data}catch(h){}try{e.link=i.getElementsByTagName("link",n.children,!1)[0].attribs.href}catch(p){}try{e.description=i.getElementsByTagName("subtitle",n.children,!1)[0].children[0].data}catch(d){}try{e.updated=new Date(i.getElementsByTagName("updated",n.children,!1)[0].children[0].data)}catch(v){}try{e.author=i.getElementsByTagName("email",n.children,!0)[0].children[0].data}catch(m){}e.items=[],i.getElementsByTagName("entry",n.children).forEach(function(t){var n={};try{n.id=i.getElementsByTagName("id",t.children,!1)[0].children[0].data}catch(r){}try{n.title=i.getElementsByTagName("title",t.children,!1)[0].children[0].data}catch(s){}try{n.link=i.getElementsByTagName("link",t.children,!1)[0].attribs.href}catch(o){}try{n.description=i.getElementsByTagName("summary",t.children,!1)[0].children[0].data}catch(u){}try{n.pubDate=new Date(i.getElementsByTagName("updated",t.children,!1)[0].children[0].data)}catch(a){}e.items.push(n)})}this.dom=e}t.super_.prototype.done.call(this)},n._emptyTags={area:1,base:1,basefont:1,br:1,col:1,frame:1,hr:1,img:1,input:1,isindex:1,link:1,meta:1,param:1,embed:1},n.reWhitespace=/^\s*$/,n.prototype.dom=null,n.prototype.reset=function(){this.dom=[],this._done=!1,this._tagStack=[],this._tagStack.last=function(){return this.length?this[this.length-1]:null}},n.prototype.done=function(){this._done=!0,this.handleCallback(null)},n.prototype.writeTag=function(e){this.handleElement(e)},n.prototype.writeText=function(e){(!this._options.ignoreWhitespace||!n.reWhitespace.test(e.data))&&this.handleElement(e)},n.prototype.writeComment=function(e){this.handleElement(e)},n.prototype.writeDirective=function(e){this.handleElement(e)},n.prototype.error=function(e){this.handleCallback(e)},n.prototype._options=null,n.prototype._callback=null,n.prototype._done=!1,n.prototype._tagStack=null,n.prototype.handleCallback=function(e){if("function"!=typeof this._callback){if(e)throw e}else this._callback(e,this.dom)},n.prototype.isEmptyTag=function(e){return e=e.name.toLowerCase(),"/"==e.charAt(0)&&(e=e.substring(1)),this._options.enforceEmptyTags&&!!n._emptyTags[e]},n.prototype.handleElement=function(e){this._done&&this.handleCallback(Error("Writing to the handler after done() called is not allowed without a reset()")),this._options.verbose||(delete e.raw,("tag"==e.type||"script"==e.type||"style"==e.type)&&delete e.data);if(this._tagStack.last())if(e.type!=r.Text&&e.type!=r.Comment&&e.type!=r.Directive)if("/"==e.name.charAt(0)){var t=e.name.substring(1);if(!this.isEmptyTag(e)){for(e=this._tagStack.length-1;-1<e&&this._tagStack[e--].name!=t;);if(-1<e||this._tagStack[0].name==t)for(;e<this._tagStack.length-1;)this._tagStack.pop()}}else this._tagStack.last().children||(this._tagStack.last().children=[]),this._tagStack.last().children.push(e),this.isEmptyTag(e)||this._tagStack.push(e);else this._tagStack.last().children||(this._tagStack.last().children=[]),this._tagStack.last().children.push(e);else e.type!=r.Text&&e.type!=r.Comment&&e.type!=r.Directive?"/"!=e.name.charAt(0)&&(this.dom.push(e),this.isEmptyTag(e)||this._tagStack.push(e)):this.dom.push(e)};var i={testElement:function(e,t){if(!t)return!1;for(var n in e)if("tag_name"==n){if("tag"!=t.type&&"script"!=t.type&&"style"!=t.type||!e.tag_name(t.name))return!1}else if("tag_type"==n){if(!e.tag_type(t.type))return!1}else if("tag_contains"==n){if("text"!=t.type&&"comment"!=t.type&&"directive"!=t.type||!e.tag_contains(t.data))return!1}else if(!t.attribs||!e[n](t.attribs[n]))return!1;return!0},getElements:function(e,t,n,r){function s(e){return function(t){return t==e}}n=void 0===n||null===n||!!n,r=isNaN(parseInt(r))?-1:parseInt(r);if(!t)return[];var o=[],u;for(u in e)"function"!=typeof e[u]&&(e[u]=s(e[u]));i.testElement(e,t)&&o.push(t);if(0<=r&&o.length>=r)return o;if(n&&t.children)t=t.children;else if(!(t instanceof Array))return o;for(u=0;u<t.length&&!(o=o.concat(i.getElements(e,t[u],n,r)),0<=r&&o.length>=r);u++);return o},getElementById:function(e,t,n){return e=i.getElements({id:e},t,n,1),e.length?e[0]:null},getElementsByTagName:function(e,t,n,r){return i.getElements({tag_name:e},t,n,r)},getElementsByTagType:function(e,t,n,r){return i.getElements({tag_type:e},t,n,r)}};exports.Parser=e,exports.DefaultHandler=n,exports.RssHandler=t,exports.ElementType=r,exports.DomUtils=i})()