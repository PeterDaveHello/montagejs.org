var common=require("../common"),assert=common.assert,http=require("http"),path=require("path"),mime=require("mime"),request=require("request"),fs=require("fs"),FormData=require(common.dir.lib+"/form_data"),IncomingForm=require("formidable").IncomingForm,remoteFile="http://nodejs.org/images/logo.png",FIELDS=[{name:"my_field",value:"my_value"},{name:"my_buffer",value:function(){return new Buffer([1,2,3])}},{name:"my_file",value:function(){return fs.createReadStream(common.dir.fixture+"/unicycle.jpg")}},{name:"remote_file",value:function(){return request(remoteFile)}}],server=http.createServer(function(e,t){var n=new IncomingForm({uploadDir:common.dir.tmp});n.parse(e),n.on("field",function(e,t){var n=FIELDS.shift();assert.strictEqual(e,n.name),assert.strictEqual(t,n.value+"")}).on("file",function(e,t){var n=FIELDS.shift();assert.strictEqual(e,n.name),assert.strictEqual(t.name,path.basename(n.value.path)),assert.strictEqual(t.type,mime.lookup(t.name))}).on("end",function(){t.writeHead(200),t.end("done")})});server.listen(common.port,function(){var e=new FormData;FIELDS.forEach(function(t){typeof t.value=="function"&&(t.value=t.value()),e.append(t.name,t.value)});var t=http.request({method:"post",port:common.port,path:"/upload",headers:e.getHeaders()});e.pipe(t),t.on("response",function(e){server.close()})}),process.on("exit",function(){assert.strictEqual(FIELDS.length,0)})