var common=require("../common"),assert=common.assert,http=require("http"),FormData=require(common.dir.lib+"/form_data"),CRLF="\r\n",testHeader="X-Test-Fake: 123",expectedLength,server=http.createServer(function(e,t){var n="";e.setEncoding("utf8"),e.on("data",function(e){n+=e}),e.on("end",function(){assert.ok(n.indexOf(testHeader)!=-1),assert.ok(typeof e.headers["content-length"]!="undefined"),assert.equal(e.headers["content-length"],expectedLength),t.writeHead(200),t.end("done")})});server.listen(common.port,function(){var e=new FormData,t={header:CRLF+"--"+e.getBoundary()+CRLF+testHeader+CRLF+CRLF,knownLength:1},n=[];for(var r=0;r<1e3;r++)n.push(1);var i=new Buffer(n);e.append("my_buffer",i,t),expectedLength=e._lastBoundary().length+e._overheadLength+t.knownLength,e.submit("http://localhost:"+common.port+"/",function(e,t){if(e)throw e;assert.strictEqual(t.statusCode,200),server.close()})})