montageDefine("99effc6","lib/form_data",{dependencies:["combined-stream","util","path","http","https","url","fs","mime","async"],factory:function(e,t,n){function h(){this._overheadLength=0,this._valueLength=0,this._lengthRetrievers=[],r.call(this)}function p(e,t){for(var n in t)e[n]||(e[n]=t[n]);return e}var r=e("combined-stream"),i=e("util"),s=e("path"),o=e("http"),u=e("https"),a=e("url").parse,f=e("fs"),l=e("mime"),c=e("async");n.exports=h,i.inherits(h,r),h.LINE_BREAK="\r\n",h.prototype.append=function(e,t,n){n=n||{};var i=r.prototype.append.bind(this);typeof t=="number"&&(t=""+t);var s=this._multiPartHeader(e,t,n),o=this._multiPartFooter(e,t,n);i(s),i(t),i(o),this._trackLength(s,t,n)},h.prototype._trackLength=function(e,t,n){var r=0;n.knownLength!=null?r+=+n.knownLength:Buffer.isBuffer(t)?r=t.length:typeof t=="string"&&(r=Buffer.byteLength(t)),this._valueLength+=r,this._overheadLength+=Buffer.byteLength(e)+ +h.LINE_BREAK.length;if(!t||!t.path&&(!t.readable||!t.hasOwnProperty("httpVersion")))return;this._lengthRetrievers.push(function(e){n.knownLength!=null?e(null,0):t.hasOwnProperty("fd")?f.stat(t.path,function(t,n){if(t){e(t);return}e(null,n.size)}):t.hasOwnProperty("httpVersion")?e(null,+t.headers["content-length"]):t.hasOwnProperty("httpModule")?(t.on("response",function(n){t.pause(),e(null,+n.headers["content-length"])}),t.resume()):e("Unknown stream")})},h.prototype._multiPartHeader=function(e,t,n){var r=this.getBoundary(),i="";return n.header!=null?i=n.header:(i+="--"+r+h.LINE_BREAK+'Content-Disposition: form-data; name="'+e+'"',n.filename||t.path?i+='; filename="'+s.basename(n.filename||t.path)+'"'+h.LINE_BREAK+"Content-Type: "+(n.contentType||l.lookup(n.filename||t.path)):t.readable&&t.hasOwnProperty("httpVersion")&&(i+='; filename="'+s.basename(t.client._httpMessage.path)+'"'+h.LINE_BREAK+"Content-Type: "+t.headers["content-type"]),i+=h.LINE_BREAK+h.LINE_BREAK),i},h.prototype._multiPartFooter=function(e,t,n){return function(e){var t=h.LINE_BREAK,n=this._streams.length===0;n&&(t+=this._lastBoundary()),e(t)}.bind(this)},h.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"},h.prototype.getHeaders=function(e){var t={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(var n in e)t[n.toLowerCase()]=e[n];return t},h.prototype.getCustomHeaders=function(e){e=e?e:"multipart/form-data";var t={"content-type":e+"; boundary="+this.getBoundary(),"content-length":this.getLengthSync()};return t},h.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},h.prototype._generateBoundary=function(){var e="--------------------------";for(var t=0;t<24;t++)e+=Math.floor(Math.random()*10).toString(16);this._boundary=e},h.prototype.getLengthSync=function(){var e=this._overheadLength+this._valueLength;return this._streams.length&&(e+=this._lastBoundary().length),e},h.prototype.getLength=function(e){var t=this._overheadLength+this._valueLength;this._streams.length&&(t+=this._lastBoundary().length);if(!this._lengthRetrievers.length){process.nextTick(e.bind(this,null,t));return}c.parallel(this._lengthRetrievers,function(n,r){if(n){e(n);return}r.forEach(function(e){t+=e}),e(null,t)})},h.prototype.submit=function(e,t){this.getLength(function(n,r){var i,s,f={method:"post",port:80,headers:this.getHeaders({"Content-Length":r})};return typeof e=="string"?(e=a(e),s=p({port:e.port,path:e.pathname,host:e.hostname},f)):s=p(e,f),e.protocol=="https:"?(e.port||(s.port=443),i=u.request(s)):i=o.request(s),this.pipe(i),t&&(i.on("error",t),i.on("response",t.bind(this,null))),i}.bind(this))}}})