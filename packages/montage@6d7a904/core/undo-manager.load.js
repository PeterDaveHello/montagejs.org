montageDefine("6d7a904","core/undo-manager",{dependencies:["montage","core/target","core/promise","collections/map","collections/list"],factory:function(e,n){var t=e("montage").Montage,s=e("core/target").Target,a=e("core/promise").Promise,o=e("collections/map"),i=e("collections/list"),r=0,l=1,p=n.UndoManager=s.specialize({_operationQueue:{value:null},_promiseOperationMap:{value:null},constructor:{value:function(){this._operationQueue=[],this._promiseOperationMap=new o,this._undoStack=new i,this._redoStack=new i,this._batchStack=new i,this.defineBinding("undoLabel",{"<-":"undoEntry.label || _promiseOperationMap.get(_undoStack.head.prev.value).label"}),this.defineBinding("undoCount",{"<-":"length",source:this._undoStack}),this.defineBinding("canUndo",{"<-":"!!length",source:this._undoStack}),this.defineBinding("isUndoing",{"<-":"!!undoEntry"}),this.defineBinding("redoLabel",{"<-":"redoEntry.label || _promiseOperationMap.get(_redoStack.head.prev.value).label"}),this.defineBinding("redoCount",{"<-":"length",source:this._redoStack}),this.defineBinding("canRedo",{"<-":"!!length",source:this._redoStack}),this.defineBinding("isRedoing",{"<-":"!!redoEntry"}),this.defineBinding("currentBatch",{"<-":"_batchStack.head.prev.value"})}},_maxUndoCount:{enumerable:!1,value:null},maxUndoCount:{get:function(){return this._maxUndoCount},set:function(e){e!==this._maxUndoCount&&(this._maxUndoCount=e,null!=this._maxUndoCount&&this._trimStacks())}},_undoStack:{value:null},undoCount:{value:0},_redoStack:{value:null},redoCount:{value:0},_trimStacks:{enumerable:!1,value:function(){var e=this._undoStack.length-this._maxUndoCount,n=this._redoStack.length-this._maxUndoCount;e>0&&this._undoStack.splice(0,e),n>0&&this._redoStack.splice(0,n)}},registrationEnabled:{value:!0},_batchStack:{value:null},currentBatch:{value:null},openBatch:{value:function(e){var n={};n.label=e,n.promisedOperations=[],this._batchStack.push(n)}},closeBatch:{value:function(){if(!this.currentBatch)throw Error("No batch operation to close");var e,n=this.currentBatch.label,t=this.currentBatch.promisedOperations,s=[],o=function(){e=Object.create(null),this.openBatch(n),s.forEach(function(n){this._resolveUndoEntry(e,n),e.undoFunction.apply(e.context,e.args)},this),this.closeBatch()},i=t.reduce(function(e,n){return e.then(function(e){return e&&s.push(e),n})},a.resolve());this._batchStack.pop();var r=this;this.register(n,i.then(function(e){return s.push(e),[o,r]}))}},register:{value:function(e,n){var t,s=this;if(!a.isPromiseAlike(n))throw Error("UndoManager expected a promise");if(0===this._maxUndoCount||!this.registrationEnabled)return a.resolve(null);if(this.currentBatch)this.currentBatch.promisedOperations.push(n),t=n;else{var o={label:e};this._promiseOperationMap.set(n,o),this.isUndoing?(o.label=this.undoLabel,this._redoStack.length===this._maxUndoCount&&this._redoStack.shift(),this._redoStack.push(n)):(this._undoStack.length===this._maxUndoCount&&this._undoStack.shift(),this._undoStack.push(n),!this.isRedoing&&this._redoStack.length>0&&this.clearRedo()),this.isUndoing||this.isRedoing||this.dispatchEventNamed("operationRegistered",!0,!1),t=n.then(function(e){return s._resolveUndoEntry(o,e),o}).then(function(){s._flushOperationQueue()})}return t}},_resolveUndoEntry:{value:function(e,n){var t,s,a,o;"string"==typeof n[0]?(t=n[0],s=n[1],a=n[2],o=3):(s=n[0],a=n[1],o=2),t&&(e.label=t),e.undoFunction=s,e.context=a,e.args=n.slice(o)}},_flushOperationQueue:{value:function(){var e,n,t,s,a=this._operationQueue,o=a.length,i=[],r=this._promiseOperationMap;if(0!==o){for(e=o-1;e>=0&&(t=a[e],s=this._promiseOperationMap.get(t),"function"==typeof s.undoFunction);e--)this._performOperation(s),i.push(t);n=i.length,n>0&&(a.splice(o-n,n),i.forEach(function(e){r.delete(e)}))}}},_performOperation:{value:function(e){e.operationType===r?this.undoEntry=e:this.redoEntry=e;var n;try{n=e.undoFunction.apply(e.context,e.args)}catch(t){throw e.deferredOperation.reject(t),t}a.isPromiseAlike(n)?n.then(function(n){e.deferredOperation.resolve(n)},function(n){e.deferredOperation.reject(n)}).done():e.deferredOperation.resolve(n),this.undoEntry=null,this.redoEntry=null}},clearUndo:{value:function(){this._undoStack.splice(0,this._undoStack.length)}},clearRedo:{value:function(){this._redoStack.splice(0,this._redoStack.length)}},isUndoing:{value:!1},isRedoing:{value:!1},undoEntry:{enumerable:!1,value:null},redoEntry:{enumerable:!1,value:null},undo:{value:function(){if(0===this.undoCount)return a.resolve(null);var e=this;return this._scheduleOperation(this._undoStack.pop(),r).then(function(n){return e.dispatchEventNamed("undo",!0,!1,n),n})}},redo:{value:function(){if(0===this.redoCount)return a.resolve(null);var e=this;return this._scheduleOperation(this._redoStack.pop(),l).then(function(n){return e.dispatchEventNamed("redo",!0,!1),n})}},_scheduleOperation:{value:function(e,n){var t=a.defer(),s=this._promiseOperationMap.get(e);return s.deferredOperation=t,s.operationType=n,this._operationQueue.push(e),this._flushOperationQueue(),t.promise}},canUndo:{value:null},canRedo:{value:null},undoLabel:{value:null},redoLabel:{value:null}}),c=null;t.defineProperty(n,"defaultUndoManager",{get:function(){return c||(c=new p),c}})}});