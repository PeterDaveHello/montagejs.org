var Fs=require("fs"),Escape=require("./escape"),internals={};exports.clone=function(e,t){if(typeof e!="object"||e===null)return e;t=t||{orig:[],copy:[]};var n=t.orig.indexOf(e);if(n!==-1)return t.copy[n];var r=e instanceof Array?[]:{};t.orig.push(e),t.copy.push(r);for(var i in e)if(e.hasOwnProperty(i))if(e[i]instanceof Buffer)r[i]=new Buffer(e[i]);else if(e[i]instanceof Date)r[i]=new Date(e[i].getTime());else if(e[i]instanceof RegExp){var s=""+(e[i].global?"g":"")+(e[i].ignoreCase?"i":"")+(e[i].multiline?"m":"");r[i]=new RegExp(e[i].source,s)}else r[i]=exports.clone(e[i],t);return r},exports.merge=function(e,t,n,r){return exports.assert(e&&typeof e=="object","Invalid target value: must be an object"),exports.assert(t===null||t===undefined||typeof t=="object","Invalid source value: must be null, undefined, or an object"),t?t instanceof Array?(exports.assert(e instanceof Array,"Cannot merge array onto an object"),r===!1&&(e.length=0),t.forEach(function(t){e.push(t)}),e):(Object.keys(t).forEach(function(i){var s=t[i];s&&typeof s=="object"?!e[i]||typeof e[i]!="object"?e[i]=exports.clone(s):exports.merge(e[i],t[i],n,r):s!==null&&s!==undefined?e[i]=s:n!==!1&&(e[i]=s)}),e):e},exports.applyToDefaults=function(e,t){exports.assert(e&&typeof e=="object","Invalid defaults value: must be an object"),exports.assert(!t||t===!0||typeof t=="object","Invalid options value: must be true, falsy or an object");if(!t)return null;var n=exports.clone(e);return t===!0?n:exports.merge(n,t,!1,!1)},exports.unique=function(e,t){var n={},r=[];for(var i=0,s=e.length;i<s;++i){var o=t?e[i][t]:e[i];n[o]!==!0&&(r.push(e[i]),n[o]=!0)}return r},exports.mapToObject=function(e,t){if(!e)return null;var n={};for(var r=0,i=e.length;r<i;++r)t?e[r][t]&&(n[e[r][t]]=!0):n[e[r]]=!0;return n},exports.intersect=function(e,t){if(!e||!t)return[];var n=[],r=e instanceof Array?exports.mapToObject(e):e,i={};for(var s=0,o=t.length;s<o;++s)r[t[s]]&&!i[t[s]]&&(n.push(t[s]),i[t[s]]=!0);return n},exports.matchKeys=function(e,t){var n=[];for(var r=0,i=t.length;r<i;++r)e.hasOwnProperty(t[r])&&n.push(t[r]);return n},exports.flatten=function(e,t){var n=t||[];for(var r=0,i=e.length;r<i;++r)Array.isArray(e[r])?exports.flatten(e[r],n):n.push(e[r]);return n},exports.removeKeys=function(e,t){for(var n=0,r=t.length;n<r;n++)delete e[t[n]]},exports.reach=function(e,t){var n=t.split("."),r=e;return n.forEach(function(e){r&&(r=r[e])}),r},exports.inheritAsync=function(e,t,n){n=n||null;for(var r in t)if(t.hasOwnProperty(r)){if(n instanceof Array&&n.indexOf(r)<0)continue;e.prototype[r]=function(e){return function(t){var n=null;try{n=e()}catch(r){return t(r)}return t(null,n)}}(t[r])}},exports.formatStack=function(e){var t=[];return e.forEach(function(e){t.push([e.getFileName(),e.getLineNumber(),e.getColumnNumber(),e.getFunctionName(),e.isConstructor()])}),t},exports.formatTrace=function(e){var t=[];return e.forEach(function(e){t.push((e[4]?"new ":"")+e[3]+" ("+e[0]+":"+e[1]+":"+e[2]+")")}),t},exports.callStack=function(e){var t=Error.prepareStackTrace;Error.prepareStackTrace=function(e,t){return t};var n={};Error.captureStackTrace(n,arguments.callee);var r=n.stack;Error.prepareStackTrace=t;var i=exports.formatStack(r);return e?i.slice(e):i},exports.displayStack=function(e){var t=exports.callStack(e===undefined?1:e+1);return exports.formatTrace(t)},exports.abortThrow=!1,exports.abort=function(e,t){if(process.env.NODE_ENV==="test"||exports.abortThrow===!0)throw new Error(e||"Unknown error");var n="";t||(n=exports.displayStack(1).join("\n	")),console.log("ABORT: "+e+"\n	"+n),process.exit(1)},exports.assert=function(e){if(e)return;var t=Array.prototype.slice.call(arguments,1);throw t=t.map(function(e){return typeof e=="string"?e:e instanceof Error?e.message:JSON.stringify(e)}),new Error(t.join(" ")||"Unknown error")},exports.loadDirModules=function(e,t,n){var r={};for(var i=0,s=t.length;i<s;++i)r[t[i]+".js"]=!0;Fs.readdirSync(e).forEach(function(t){if(/\.js$/.test(t)&&!r[t]){var i=t.substr(0,t.lastIndexOf(".")),s=i.charAt(0).toUpperCase()+i.substr(1).toLowerCase();typeof n!="function"?n[s]=require(e+"/"+i):n(e+"/"+i,i,s)}})},exports.rename=function(e,t,n){e[n]=e[t],delete e[t]},exports.Timer=function(){this.reset()},exports.Timer.prototype.reset=function(){this.ts=Date.now()},exports.Timer.prototype.elapsed=function(){return Date.now()-this.ts},exports.loadPackage=function(e){var t={},n=(e||process.env.PWD)+"/package.json";if(Fs.existsSync(n))try{t=JSON.parse(Fs.readFileSync(n))}catch(r){}return t},exports.escapeRegex=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")},exports.toss=function(e){var t=arguments.length===3?arguments[1]:"",n=arguments.length===3?arguments[2]:arguments[1],r=t instanceof Error?t:t?new Error(t):e instanceof Error?e:new Error;if(e instanceof Error||!e)return n(r)},exports.base64urlEncode=function(e){return(new Buffer(e,"binary")).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")},exports.base64urlDecode=function(e){if(e&&!e.match(/^[\w\-]*$/))return new Error("Invalid character");try{return(new Buffer(e.replace(/-/g,"+").replace(/:/g,"/"),"base64")).toString("binary")}catch(t){return t}},exports.escapeHeaderAttribute=function(e){return exports.assert(e.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~\"\\]*$/),"Bad attribute value ("+e+")"),e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},exports.escapeHtml=function(e){return Escape.escapeHtml(e)},exports.escapeJavaScript=function(e){return Escape.escapeJavaScript(e)},exports.consoleFunc=console.log,exports.printEvent=function(e){var t=function(e){return(e<10?"0":"")+e},n=new Date(e.timestamp),r=(n.getYear()-100).toString()+t(n.getMonth()+1)+t(n.getDate())+"/"+t(n.getHours())+t(n.getMinutes())+t(n.getSeconds())+"."+n.getMilliseconds(),i=e.data;if(typeof e.data!="string")try{i=JSON.stringify(e.data)}catch(s){i="JSON Error: "+s.message}var o=r+", "+e.tags[0]+", "+i;exports.consoleFunc(o)},exports.nextTick=function(e){return function(){var t=arguments;process.nextTick(function(){e.apply(null,t)})}}