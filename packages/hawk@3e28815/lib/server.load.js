montageDefine("3e28815","lib/server",{dependencies:["boom","hoek","cryptiles","./crypto","./utils"],factory:function(e,t,n){var r=e("boom"),i=e("hoek"),s=e("cryptiles"),o=e("./crypto"),u=e("./utils"),a={};t.authenticate=function(e,t,n,i){i=u.nextTick(i),n.nonceFunc=n.nonceFunc||function(e,t,n){return n()},n.timestampSkewSec=n.timestampSkewSec||60;var a=u.now()+(n.localtimeOffsetMsec||0),f=u.parseRequest(e,n);if(f instanceof Error)return i(r.badRequest(f.message));var l=u.parseAuthorizationHeader(f.authorization);if(l instanceof Error)return i(l);var c={method:f.method,host:f.host,port:f.port,resource:f.url,ts:l.ts,nonce:l.nonce,hash:l.hash,ext:l.ext,app:l.app,dlg:l.dlg,mac:l.mac,id:l.id};if(!l.id||!l.ts||!l.nonce||!l.mac)return i(r.badRequest("Missing attributes"),null,c);t(l.id,function(e,t){if(e)return i(e,t||null,c);if(!t)return i(r.unauthorized("Unknown credentials","Hawk"),null,c);if(!t.key||!t.algorithm)return i(r.internal("Invalid credentials"),t,c);if(o.algorithms.indexOf(t.algorithm)===-1)return i(r.internal("Unknown algorithm"),t,c);var h=o.calculateMac("header",t,c);if(!s.fixedTimeComparison(h,l.mac))return i(r.unauthorized("Bad mac","Hawk"),t,c);if(n.payload!==null&&n.payload!==undefined){if(!l.hash)return i(r.unauthorized("Missing required payload hash","Hawk"),t,c);var p=o.calculatePayloadHash(n.payload,t.algorithm,f.contentType);if(!s.fixedTimeComparison(p,l.hash))return i(r.unauthorized("Bad payload hash","Hawk"),t,c)}n.nonceFunc(l.nonce,l.ts,function(e){if(e)return i(r.unauthorized("Invalid nonce","Hawk"),t,c);if(Math.abs(l.ts*1e3-a)>n.timestampSkewSec*1e3){var s=Math.floor((u.now()+(n.localtimeOffsetMsec||0))/1e3),f=o.calculateTsMac(s,t);return i(r.unauthorized("Stale timestamp","Hawk",{ts:s,tsm:f}),t,c)}return i(null,t,c)})})},t.authenticatePayload=function(e,t,n,r){var i=o.calculatePayloadHash(e,t.algorithm,r);return s.fixedTimeComparison(i,n.hash)},t.header=function(e,t,n){n=n||{};if(!t||typeof t!="object"||typeof n!="object")return"";t=i.clone(t),delete t.mac,t.hash=n.hash,t.ext=n.ext;if(!e||!e.key||!e.algorithm)return"";if(o.algorithms.indexOf(e.algorithm)===-1)return"";!t.hash&&n.hasOwnProperty("payload")&&(t.hash=o.calculatePayloadHash(n.payload,e.algorithm,n.contentType));var r=o.calculateMac("response",e,t),s='Hawk mac="'+r+'"'+(t.hash?', hash="'+t.hash+'"':"");return t.ext!==null&&t.ext!==undefined&&t.ext!==""&&(s+=', ext="'+u.escapeHeaderAttribute(t.ext)+'"'),s},t.authenticateBewit=function(e,t,n,i){i=u.nextTick(i);var a=u.now()+(n.localtimeOffsetMsec||0),f=u.parseRequest(e,n);if(f instanceof Error)return i(r.badRequest(f.message));var l=f.url.match(/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/);if(!l)return i(r.unauthorized(null,"Hawk"));if(!l[3])return i(r.unauthorized("Empty bewit","Hawk"));if(f.method!=="GET"&&f.method!=="HEAD")return i(r.unauthorized("Invalid method","Hawk"));if(f.authorization)return i(r.badRequest("Multiple authentications","Hawk"));var c=u.base64urlDecode(l[3]);if(c instanceof Error)return i(r.badRequest("Invalid bewit encoding"));var h=c.split("\\");if(!h||h.length!==4)return i(r.badRequest("Invalid bewit structure"));var p={id:h[0],exp:parseInt(h[1],10),mac:h[2],ext:h[3]||""};if(!p.id||!p.exp||!p.mac)return i(r.badRequest("Missing bewit attributes"));var d=l[1];l[4]&&(d+=l[2]+l[4]);if(p.exp*1e3<=a)return i(r.unauthorized("Access expired","Hawk"),null,p);t(p.id,function(e,t){if(e)return i(e,t||null,p.ext);if(!t)return i(r.unauthorized("Unknown credentials","Hawk"),null,p);if(!t.key||!t.algorithm)return i(r.internal("Invalid credentials"),t,p);if(o.algorithms.indexOf(t.algorithm)===-1)return i(r.internal("Unknown algorithm"),t,p);var n=o.calculateMac("bewit",t,{ts:p.exp,nonce:"",method:"GET",resource:d,host:f.host,port:f.port,ext:p.ext});return s.fixedTimeComparison(n,p.mac)?i(null,t,p):i(r.unauthorized("Bad mac","Hawk"),t,p)})}}})