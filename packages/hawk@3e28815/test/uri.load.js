montageDefine("3e28815","test/uri",{dependencies:["http","lab","../lib"],factory:function(e,t,n){var r=e("http"),i=e("lab"),s=e("../lib"),o={},u=i.expect,a=i.before,f=i.after,l=i.experiment,c=i.test;l("Hawk",function(){l("Uri",function(){var e=function(e,t){var n={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return t(null,n)};c("should generate a bewit then successfully authenticate it",function(t){var n={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,i){var o=s.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5,ext:"some-app-data"});n.url+="&bewit="+o,s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.not.exist,u(n.user).to.equal("steve"),u(r.ext).to.equal("some-app-data"),t()})})}),c("should generate a bewit then successfully authenticate it (no ext)",function(t){var n={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(r,i){var o=s.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5});n.url+="&bewit="+o,s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.not.exist,u(n.user).to.equal("steve"),t()})})}),c("should successfully authenticate a request (last param)",function(t){var n={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.not.exist,u(n.user).to.equal("steve"),u(r.ext).to.equal("some-app-data"),t()})}),c("should successfully authenticate a request (first param)",function(t){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&a=1&b=2",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.not.exist,u(n.user).to.equal("steve"),u(r.ext).to.equal("some-app-data"),t()})}),c("should successfully authenticate a request (only param)",function(t){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.not.exist,u(n.user).to.equal("steve"),u(r.ext).to.equal("some-app-data"),t()})}),c("should fail on multiple authentication",function(t){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Multiple authentications"),t()})}),c("should fail on method other than GET",function(t){e("123456",function(n,r){var i={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080},o=Math.floor(s.utils.now()/1e3)+60,a="some-app-data",f=s.crypto.calculateMac("bewit",r,{timestamp:o,nonce:"",method:i.method,resource:i.url,host:i.host,port:i.port,ext:a}),l=r.id+"\\"+o+"\\"+f+"\\"+a;i.url+="&bewit="+s.utils.base64urlEncode(l),s.uri.authenticate(i,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Invalid method"),t()})})}),c("should fail on invalid host header",function(t){var n={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",headers:{host:"example.com:something"}};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Invalid Host header"),t()})}),c("should fail on empty bewit",function(t){var n={method:"GET",url:"/resource/4?bewit=",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Empty bewit"),u(e.isMissing).to.not.exist,t()})}),c("should fail on invalid bewit",function(t){var n={method:"GET",url:"/resource/4?bewit=*",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Invalid bewit encoding"),u(e.isMissing).to.not.exist,t()})}),c("should fail on missing bewit",function(t){var n={method:"GET",url:"/resource/4",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.not.exist,u(e.isMissing).to.equal(!0),t()})}),c("should fail on invalid bewit structure",function(t){var n={method:"GET",url:"/resource/4?bewit=abc",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Invalid bewit structure"),t()})}),c("should fail on empty bewit attribute",function(t){var n={method:"GET",url:"/resource/4?bewit=YVxcY1xk",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Missing bewit attributes"),t()})}),c("should fail on expired access",function(t){var n={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(n,e,{},function(e,n,r){u(e).to.exist,u(e.response.payload.message).to.equal("Access expired"),t()})}),c("should fail on credentials function error",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(t,function(e,t){t(s.error.badRequest("Boom"))},{},function(t,n,r){u(t).to.exist,u(t.response.payload.message).to.equal("Boom"),e()})}),c("should fail on null credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(t,function(e,t){t(null,null)},{},function(t,n,r){u(t).to.exist,u(t.response.payload.message).to.equal("Unknown credentials"),e()})}),c("should fail on invalid credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(t,function(e,t){t(null,{})},{},function(t,n,r){u(t).to.exist,u(t.message).to.equal("Invalid credentials"),e()})}),c("should fail on invalid credentials function response (unknown algorithm)",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"xxx"})},{},function(t,n,r){u(t).to.exist,u(t.message).to.equal("Unknown algorithm"),e()})}),c("should fail on expired access",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};s.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"sha256"})},{},function(t,n,r){u(t).to.exist,u(t.response.payload.message).to.equal("Bad mac"),e()})})}),l("#getBewit",function(){c("should return a valid bewit value",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},n=s.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-s.utils.now(),ext:"xandyandz"});u(n).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),c("should return an empty bewit on invalid credentials",function(e){var t={key:"2983d45yun89q",algorithm:"sha256"},n=s.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});u(n).to.equal(""),e()}),c("should return an empty bewit on invalid algorithm",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},n=s.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,ext:"xandyandz"});u(n).to.equal(""),e()}),c("should return an empty bewit on missing options",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},n=s.uri.getBewit("https://example.com/somewhere/over/the/rainbow");u(n).to.equal(""),e()})})})}})