var Montage=require("core/core").Montage,Target=require("core/target").Target,MontageWindow=require("window-loader/montage-window").MontageWindow,Slot;require("core/dom");var Application=exports.Application=Target.specialize({eventManager:{value:null},parentApplication:{value:null},mainApplication:{get:function(){for(var e=this;e.parentApplication;)e=e.parentApplication;return e}},_windowsSortOrder:{value:"reverse-z-order"},windowsSortOrder:{get:function(){return null==this.parentApplication?this._windowsSortOrder:this.mainApplication.windowsSortOrder},set:function(e){null==this.parentApplication?-1!==["z-order","reverse-z-order","z-order","reverse-open-order"].indexOf(e)&&(this._windowsSortOrder=e):this.mainApplication.windowsSortOrder=e}},windows:{get:function(){var e;if(null==this.parentApplication){if(!this._windows){var e=new MontageWindow;e.application=this,e.window=window,this.window=e,this._windows=[this.window],this._multipleWindow=!0}return this._windows}return this.mainApplication.windows}},_window:{value:null},window:{get:function(){if(!this._window&&this==this.mainApplication){var e=new MontageWindow;e.application=this,e.window=window,this._window=e}return this._window},set:function(e){this._window||(this._window=e)}},attachedWindows:{value:[]},eventManagerForWindow:{value:function(e){return e.defaultEventMananger}},focusWindow:{get:function(){var e=this.windows,n=this.windowsSortOrder;if("z-order"==n)return e[0];if("reverse-z-order"==n)return e[e.length-1];for(var t in e)if(e[t].focused)return e[t]}},addEventListener:{value:function(e,n,t){Object.getPrototypeOf(Application).addEventListener.call(this,e,n,t)}},removeEventListener:{value:function(e,n,t){Object.getPrototypeOf(Application).removeEventListener.call(this,e,n,t)}},delegate:{value:null},nextTarget:{get:function(){return this.delegate}},openWindow:{value:function(e,n,t){var a,s,r=this,i=new MontageWindow,o={location:!1,menubar:!1,resizable:!0,scrollbars:!0,status:!1,titlebar:!0,toolbar:!1},l={module:e,name:n,parent:window,callback:function(e,n){var t;a=e.document.application,i.window=e,i.application=a,i.component=n,a.window=i,r.attachedWindows.push(i),t=r.mainApplication.windowsSortOrder,"z-order"==t||"reverse-open-order"==t?r.windows.unshift(i):r.windows.push(i),s=document.createEvent("CustomEvent"),s.initCustomEvent("load",!0,!0,null),i.dispatchEvent(s)}};if(this!==this.mainApplication||this._multipleWindow||this.window,"object"==typeof t){var p,c,u="",h="";for(p in t)t.hasOwnProperty(p)&&(o[p]=t[p])}var d=["name"];for(p in o)-1==d.indexOf(p)&&(c=o[p],"boolean"==typeof c?c=c?"yes":"no":(c+="",c.match(/[ ,"]/)&&(c='"'+c.replace(/"/g,'\\"')+'"')),h+=u+p+"="+c,u=",");return window.require.loadPackage({name:"montage"}).then(function(e){var n=window.open(e.location+"window-loader/index.html","_blank",h);n.loadInfo=l}).done(),i}},attachWindow:{value:function(e){var n,t=e.application.parentApplication;return t!==this&&(t&&t.detachWindow(e),e.parentApplication=this,this.attachedWindows.push(e),n=this.mainApplication.windowsSortOrder,"z-order"==n||"reverse-open-order"==n?this.windows.unshift(e):this.windows.push(e),e.focus()),e}},detachWindow:{value:function(e){var n,t,a=this.windows;return void 0===e&&(e=this.window),t=e.application.parentApplication,t==this?(n=this.attachedWindows.indexOf(e),-1!==n&&this.attachedWindows.splice(n,1),n=a.indexOf(e),-1!==n&&a.splice(n,1),e.application.parentApplication=null):t&&t.detachWindow(e),e}},constructor:{value:function(){window.loadInfo&&!this.parentApplication&&(this.parentApplication=window.loadInfo.parent.document.application)}},_load:{value:function(e,n){var t,a=this;exports.application=a,require.async("ui/component").then(function(s){return t=s.__root__,t.element=document,require("core/template").instantiateDocument(window.document,e).then(function(){a.callDelegateMethod("willFinishLoading",a),t.needsDraw=!0,n&&n(a)})}).done()}},_alertPopup:{value:null,enumerable:!1},_confirmPopup:{value:null,enumerable:!1},_notifyPopup:{value:null,enumerable:!1},_zIndex:{value:null},_isSystemPopup:{value:function(e){return"alert"===e||"confirm"===e||"notify"===e}},_createPopupSlot:{value:function(e){var n=document.createElement("div");document.body.appendChild(n),n.style.zIndex=e,n.style.position="absolute";var t=new Slot;return t.element=n,t.attachToParentComponent(),t}},getPopupSlot:{value:function(e,n,t){var a=this;require.async("ui/slot.reel/slot").then(function(s){Slot=Slot||s.Slot,e=e||"custom";var r,i,o=a._isSystemPopup(e);if(a.popupSlots=a.popupSlots||{},o)switch(e){case"alert":r=9004;break;case"confirm":r=9003;break;case"notify":r=9002}else a._zIndex=a._zIndex?a._zIndex+1:7e3,r=a._zIndex;i=a.popupSlots[e],i||(i=a.popupSlots[e]=a._createPopupSlot(r)),o||(i.element.style.zIndex=r),i.content=n,t.call(this,i)}).done()}},returnPopupSlot:{value:function(e){var n=this;if(n.popupSlots&&n.popupSlots[e]){var t=n.popupSlots[e];t.content=null}}},_getActivePopupSlots:{value:function(){var e=[];if(this.popupSlots){var n=Object.keys(this.popupSlots);if(n&&n.length>0){var t,a=0,s=n.length;for(a=0;s>a;a++)t=this.popupSlots[n[a]],t&&null!==t.content&&e.push(t)}}return e}}});